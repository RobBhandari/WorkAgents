{% extends "base.html" %}

{% block title %}ArmorCode Vulnerability Tracking Report{% endblock %}

{% block extra_styles %}
/* ArmorCode-specific styles */
.timestamp {
    color: #666;
    font-size: 14px;
    margin-bottom: 30px;
}

/* Executive Summary */
.executive-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.summary-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 25px;
    text-align: center;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 25px;
    text-align: center;
}

.summary-item {
    background: rgba(255, 255, 255, 0.15);
    padding: 20px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.summary-label {
    font-size: 13px;
    opacity: 0.9;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.summary-value {
    font-size: 36px;
    font-weight: 700;
    line-height: 1;
}

.summary-unit {
    font-size: 14px;
    opacity: 0.8;
    margin-top: 5px;
}

.progress-section {
    background: rgba(255, 255, 255, 0.15);
    padding: 20px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
    margin-top: 20px;
}

.progress-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.progress-row:last-child {
    border-bottom: none;
}

.progress-label {
    font-size: 14px;
    opacity: 0.9;
}

.progress-value {
    font-size: 18px;
    font-weight: 600;
}

/* Statistics Cards */
.stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin: 30px 0;
}

.stat-card.critical {
    border-color: #ff4444;
    background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
}

.stat-card.high {
    border-color: #ff8800;
    background: linear-gradient(135deg, #fff 0%, #fff8f0 100%);
}

.stat-card.critical h3 {
    color: #ff4444;
}

.stat-card.high h3 {
    color: #ff8800;
}

/* Trend Chart */
.trend-section {
    margin: 30px 0;
    padding: 30px;
    background: #f8f9fa;
    border-radius: 8px;
}

.trend-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #2c3e50;
}

.trend-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.trend-table th {
    background: #667eea;
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
}

.trend-table td {
    padding: 12px;
    border-bottom: 1px solid #e2e8f0;
    font-size: 14px;
}

.trend-table tr:last-child td {
    border-bottom: none;
}

.trend-bar {
    height: 20px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 4px;
    margin: 5px 0;
}

/* Vulnerabilities Table */
.section-title {
    font-size: 24px;
    font-weight: 600;
    margin: 40px 0 20px 0;
    color: #2c3e50;
}

.table-controls {
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
}

.search-input {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
}

.vulns-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.vulns-table th {
    background: #2c3e50;
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    user-select: none;
}

.vulns-table th:hover {
    background: #34495e;
}

.vulns-table td {
    padding: 15px;
    border-bottom: 1px solid #e2e8f0;
    font-size: 14px;
    color: #4a5568;
}

.vulns-table tr:hover {
    background: #f7fafc;
}

.severity-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.severity-critical {
    background: #ff4444;
    color: white;
}

.severity-high {
    background: #ff8800;
    color: white;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    background: #e2e8f0;
    color: #2c3e50;
}

.vuln-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.vuln-id {
    font-size: 12px;
    color: #718096;
}

/* Responsive */
@media (max-width: 1200px) {
    .summary-grid {
        grid-template-columns: 1fr;
    }
    .stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .stats {
        grid-template-columns: 1fr;
    }
}

/* Print styles */
@media print {
    .search-input {
        display: none;
    }
}
{% endblock %}

{% block content %}
<h1 style="font-size: 32px; color: #1a1a1a; margin-bottom: 10px; font-weight: 600;">ArmorCode Vulnerability Tracking Report</h1>
<div class="timestamp">Generated: {{ generated_at }}</div>

<!-- Executive Summary -->
<div class="executive-summary">
    <div class="summary-title">Vulnerability Reduction Progress</div>

    <div class="summary-grid">
        <div class="summary-item">
            <div class="summary-label">Baseline ({{ baseline.date }})</div>
            <div class="summary-value">{{ baseline.count }}</div>
            <div class="summary-unit">vulnerabilities</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Target ({{ target.reduction_goal_pct }}% Reduction)</div>
            <div class="summary-value">{{ target.count }}</div>
            <div class="summary-unit">vulnerabilities</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Current</div>
            <div class="summary-value">{{ current.count }}</div>
            <div class="summary-unit">vulnerabilities</div>
        </div>
    </div>

    <div class="progress-section">
        <div class="progress-row">
            <span class="progress-label">Vulnerabilities Reduced:</span>
            <span class="progress-value">{{ comparison.reduction_amount }} ({{ comparison.reduction_pct }}%)</span>
        </div>
        <div class="progress-row">
            <span class="progress-label">Remaining to Goal:</span>
            <span class="progress-value">{{ comparison.remaining_to_goal }} vulnerabilities</span>
        </div>
        <div class="progress-row">
            <span class="progress-label">Goal Progress:</span>
            <span class="progress-value">{{ comparison.progress_to_goal_pct }}% of the way there</span>
        </div>
        <div class="progress-row">
            <span class="progress-label">Days Since Baseline:</span>
            <span class="progress-value">{{ comparison.days_since_baseline }} days</span>
        </div>
        <div class="progress-row">
            <span class="progress-label">Days to Target:</span>
            <span class="progress-value">{{ comparison.days_to_target }} days</span>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats">
    <div class="stat-card">
        <p>Total</p>
        <h3>{{ current.count }}</h3>
    </div>
    <div class="stat-card critical">
        <p>Critical</p>
        <h3>{{ critical_count }}</h3>
    </div>
    <div class="stat-card high">
        <p>High</p>
        <h3>{{ high_count }}</h3>
    </div>
    <div class="stat-card">
        <p>Products</p>
        <h3>{{ product_count }}</h3>
    </div>
</div>

{% if tracking_history and tracking_history|length > 1 %}
<!-- Trend Chart -->
<div class="trend-section">
    <div class="trend-title">Vulnerability Trend Over Time</div>
    <table class="trend-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Count</th>
                <th>% of Baseline</th>
                <th>Reduction</th>
                <th>Trend</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in tracking_history[-10:] %}
            {% set pct_of_baseline = (entry.count / baseline.count * 100) if baseline.count > 0 else 0 %}
            {% set bar_width = pct_of_baseline|int %}
            <tr>
                <td>{{ entry.date }}</td>
                <td>{{ entry.count }}</td>
                <td>{{ "%.1f"|format(pct_of_baseline) }}%</td>
                <td>{{ "%.1f"|format(entry.reduction_pct|default(0)) }}%</td>
                <td><div class="trend-bar" style="width: {{ bar_width }}%;"></div></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Vulnerabilities Table -->
<h2 class="section-title">Current Vulnerabilities ({{ current.count }})</h2>

<div class="table-controls">
    <input type="text" class="search-input" id="searchInput" placeholder="Search vulnerabilities..." onkeyup="filterTable()">
</div>

<table class="vulns-table" id="vulnsTable">
    <thead>
        <tr>
            <th onclick="sortTable(0)">Severity ▼</th>
            <th onclick="sortTable(1)">Product ▼</th>
            <th onclick="sortTable(2)">Title ▼</th>
            <th onclick="sortTable(3)">CVE/CWE ▼</th>
            <th onclick="sortTable(4)">Status ▼</th>
            <th onclick="sortTable(5)">First Seen ▼</th>
        </tr>
    </thead>
    <tbody>
        {% for vuln in sorted_vulns %}
        {% set severity = vuln.severity|default('UNKNOWN') %}
        {% set severity_class = severity.lower() if severity in ['CRITICAL', 'HIGH'] else '' %}
        {% set cve_cwe = [vuln.cve, vuln.cwe]|select|join(', ') %}
        <tr>
            <td>
                <span class="severity-badge severity-{{ severity_class }}">{{ severity }}</span>
            </td>
            <td>{{ vuln.product|default('N/A') }}</td>  {# AUTO-ESCAPED #}
            <td>
                <div class="vuln-title">{{ vuln.title|default('N/A') }}</div>  {# AUTO-ESCAPED #}
                <div class="vuln-id">{{ vuln.id|default('') }}</div>  {# AUTO-ESCAPED #}
            </td>
            <td>{{ cve_cwe or 'N/A' }}</td>  {# AUTO-ESCAPED #}
            <td><span class="status-badge">{{ vuln.status|default('Unknown') }}</span></td>  {# AUTO-ESCAPED #}
            <td>{{ vuln.first_seen[:10] if vuln.first_seen else 'N/A' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Footer Override -->
<div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #718096; font-size: 14px;">
    <p>ArmorCode Vulnerability Tracking System | Generated from baseline: {{ baseline.date }}</p>
    <p>Target: {{ target.reduction_goal_pct }}% reduction by {{ target.date }}</p>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Table search filter
    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('vulnsTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent || row.innerText;
            row.style.display = text.toLowerCase().includes(filter) ? '' : 'none';
        }
    }

    // Table sorting
    function sortTable(columnIndex) {
        const table = document.getElementById('vulnsTable');
        const rows = Array.from(table.rows).slice(1);
        const isAscending = table.dataset.sortOrder !== 'asc';

        rows.sort((a, b) => {
            const aText = a.cells[columnIndex].textContent.trim();
            const bText = b.cells[columnIndex].textContent.trim();
            return isAscending ? aText.localeCompare(bText) : bText.localeCompare(aText);
        });

        rows.forEach(row => table.tBodies[0].appendChild(row));
        table.dataset.sortOrder = isAscending ? 'asc' : 'desc';
    }
</script>
{% endblock %}
