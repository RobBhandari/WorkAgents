{% extends "dashboards/base_dashboard.html" %}

{% block title %}Cross-Project Analysis{% endblock %}
{% block header_title %}Cross-Project Performance Analysis{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODERN MINIMALIST - Refined Dashboard Styling
   Design Direction: Clean, Refined, Professional
   Inspiration: Stripe, Linear, Modern SaaS dashboards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
    --color-slate-50: #f8fafc;
    --color-slate-100: #f1f5f9;
    --color-slate-200: #e2e8f0;
    --color-slate-300: #cbd5e1;
    --color-slate-400: #94a3b8;
    --color-slate-500: #64748b;
    --color-slate-600: #475569;
    --color-slate-700: #334155;
    --color-slate-800: #1e293b;
    --color-slate-900: #0f172a;

    --color-blue-400: #60a5fa;
    --color-blue-500: #3b82f6;
    --color-blue-600: #2563eb;

    --color-emerald-500: #10b981;
    --color-amber-500: #f59e0b;
    --color-red-500: #ef4444;

    --header-gradient-start: var(--color-slate-900) !important;
    --header-gradient-end: var(--color-slate-900) !important;
}

/* Refined typography - Inter with OpenType features */
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    background: var(--color-slate-900) !important;
    color: #ffffff !important;
    font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Sophisticated header */
body .header,
.container .header,
div.header {
    background: var(--color-slate-900) !important;
    border: none !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 64px 32px !important;
}

.header h1 {
    font-weight: 600 !important;
    letter-spacing: -0.02em !important;
    color: #ffffff !important;
    text-transform: none !important;
    font-size: 2.5rem !important;
}

.header p,
.header .subtitle {
    color: var(--color-slate-400) !important;
    font-weight: 400 !important;
    text-transform: none !important;
    letter-spacing: 0 !important;
}

/* Summary Cards - Refined with subtle borders */
.summary-card,
.card {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 24px !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.summary-card:hover,
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3) !important;
    border-color: rgba(59, 130, 246, 0.3) !important;
}

/* Tables - Refined styling */
table {
    border-collapse: collapse !important;
}

th {
    background: var(--color-slate-800) !important;
    color: var(--color-slate-400) !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    padding: 14px 16px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
}

tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    transition: background-color 0.2s ease !important;
}

tbody tr:hover {
    background: rgba(255, 255, 255, 0.02) !important;
}

td {
    padding: 12px 16px !important;
    color: #ffffff !important;
}

/* Preserve chevron spacing for expandable rows */
tbody tr.data-row td:first-child {
    padding-left: 30px !important;
}

tbody tr.data-row td:first-child::before {
    content: 'â–¶';
    position: absolute;
    left: 12px;
    font-size: 0.7rem;
    color: var(--color-slate-400);
    transition: transform 0.3s ease;
}

tbody tr.data-row.expanded td:first-child::before {
    transform: rotate(90deg);
}

/* Status badges - Refined colors */
.status-good { color: var(--color-emerald-500) !important; }
.status-caution { color: var(--color-amber-500) !important; }
.status-action { color: var(--color-red-500) !important; }
.status-inactive { color: var(--color-slate-500) !important; }

/* Detail rows - Refined styling */
.detail-row {
    display: none;
}

.detail-row.show {
    display: table-row;
}

.detail-content {
    background: var(--color-slate-800) !important;
    padding: 24px !important;
    border-left: 2px solid rgba(59, 130, 246, 0.3) !important;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h3,
.detail-section h4 {
    color: #ffffff !important;
    margin-bottom: 12px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.detail-metric {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 16px !important;
    color: var(--color-slate-300) !important;
}

.detail-metric-label {
    font-size: 0.75rem !important;
    text-transform: uppercase !important;
    color: var(--color-slate-400) !important;
    margin-bottom: 8px !important;
    letter-spacing: 0.05em !important;
}

.detail-metric-value {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    color: #ffffff !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIGHT THEME SUPPORT - Complete styling for light mode
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

[data-theme="light"] body {
    background: #ffffff !important;
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header {
    background: #ffffff !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] .header h1 {
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header p,
[data-theme="light"] .header .subtitle {
    color: var(--color-slate-600) !important;
}

[data-theme="light"] .summary-card,
[data-theme="light"] .card {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03) !important;
}

[data-theme="light"] .summary-card:hover,
[data-theme="light"] .card:hover {
    border-color: var(--color-blue-400) !important;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05) !important;
}

[data-theme="light"] th {
    background: var(--color-slate-100) !important;
    color: var(--color-slate-700) !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr {
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr:hover {
    background: var(--color-slate-50) !important;
}

[data-theme="light"] td {
    color: var(--color-slate-900) !important;
}

/* Detail rows - Light Mode */
[data-theme="light"] .detail-content {
    background: var(--color-slate-100) !important;
}

[data-theme="light"] .detail-metric {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
}

[data-theme="light"] .detail-metric-value {
    color: var(--color-slate-900) !important;
}

/* Chevron - Light Mode */
[data-theme="light"] tbody tr.data-row td:first-child::before {
    color: var(--color-slate-600) !important;
}

/* Footer - Light Mode */
[data-theme="light"] .footer p {
    color: var(--color-slate-600) !important;
}
</style>

{% endblock %}

{% block content %}
<!-- Performance Banner -->
<div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem;">âš¡ Parallel Collection Performance</h3>
            <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">
                Async REST API enables simultaneous collection across {{ project_count }} projects with 3-10x speedup
            </p>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 2.5rem; font-weight: bold;">{{ project_count }}</div>
            <div style="font-size: 0.85rem; opacity: 0.9;">Projects Analyzed</div>
        </div>
    </div>
</div>

<!-- Top Performers -->
<div style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem;">ğŸ† Top Performers</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <!-- Best Quality -->
        <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #059669; font-size: 1rem;">Best Quality (Fewest Bugs)</h4>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                {% for project in rankings.best_quality %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f0fdf4; border-radius: 4px;">
                    <div>
                        <div style="font-weight: 600;">{{ project.project_name or project.project_key }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">{{ project.project_key }}</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">{{ project.open_bugs }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Best Deployment -->
        <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #0891b2; font-size: 1rem;">Best Deployment (Most Frequent)</h4>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                {% for project in rankings.best_deployment %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #ecfeff; border-radius: 4px;">
                    <div>
                        <div style="font-weight: 600;">{{ project.project_name or project.project_key }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">{{ project.project_key }}</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #0891b2;">{{ "%.1f"|format(project.deployments_per_week or 0) }}/wk</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Best Reliability -->
        <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #7c3aed; font-size: 1rem;">Best Reliability (Success Rate)</h4>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                {% for project in rankings.best_reliability %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f5f3ff; border-radius: 4px;">
                    <div>
                        <div style="font-weight: 600;">{{ project.project_name or project.project_key }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">{{ project.project_key }}</div>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #7c3aed;">{{ "%.1f"|format(project.success_rate or 0) }}%</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Outliers -->
{% if outliers.bug_count_outliers %}
<div style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem;">âš ï¸ Statistical Outliers</h3>
    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
        <div style="margin-bottom: 1rem; padding: 1rem; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
            <div style="font-size: 0.875rem; color: #991b1b;">
                <strong>Mean Bugs:</strong> {{ outliers.mean_bugs }} | <strong>Std Dev:</strong> {{ outliers.std_dev }}
            </div>
            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                Projects with >2 standard deviations from mean are flagged
            </div>
        </div>

        <div style="display: grid; gap: 0.75rem;">
            {% for outlier in outliers.bug_count_outliers %}
            <div style="padding: 1rem; background: {{ '#fef2f2' if outlier.severity == 'high' else '#fef3c7' }}; border-left: 3px solid {{ '#ef4444' if outlier.severity == 'high' else '#f59e0b' }}; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #111827;">{{ outlier.project_name }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                            z-score: {{ outlier.z_score }} ({{ outlier.severity }} severity)
                        </div>
                    </div>
                    <div style="font-size: 1.75rem; font-weight: bold; color: {{ '#ef4444' if outlier.severity == 'high' else '#f59e0b' }};">
                        {{ outlier.open_bugs }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Needs Improvement -->
<div style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem;">ğŸ“Š Needs Improvement</h3>
    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem;">
        <h4 style="margin: 0 0 1rem 0; color: #dc2626; font-size: 1rem;">Highest Bug Counts</h4>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            {% for project in rankings.worst_quality %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #fef2f2; border-radius: 4px;">
                <div>
                    <div style="font-weight: 600;">{{ project.project_name or project.project_key }}</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">
                        {{ project.project_key }} |
                        P1: {{ project.priority_1_bugs or 0 }} |
                        P2: {{ project.priority_2_bugs or 0 }}
                    </div>
                </div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">{{ project.open_bugs }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- All Projects Table -->
<div style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem;">All Projects - Comparative View</h3>
    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
            <thead>
                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Project</th>
                    <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">Open Bugs</th>
                    <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">P1 Bugs</th>
                    <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">P2 Bugs</th>
                    <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">Deploy/Week</th>
                    <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">Success Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 0.75rem;">
                        <div style="font-weight: 600;">{{ project.project_name or project.project_key }}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">{{ project.project_key }}</div>
                    </td>
                    <td style="padding: 0.75rem; text-align: center; font-weight: 600; color: {{ '#22c55e' if project.open_bugs < 50 else '#f59e0b' if project.open_bugs < 100 else '#ef4444' }};">
                        {{ project.open_bugs or 0 }}
                    </td>
                    <td style="padding: 0.75rem; text-align: center;">{{ project.priority_1_bugs or 0 }}</td>
                    <td style="padding: 0.75rem; text-align: center;">{{ project.priority_2_bugs or 0 }}</td>
                    <td style="padding: 0.75rem; text-align: center;">{{ "%.1f"|format(project.deployments_per_week or 0) }}</td>
                    <td style="padding: 0.75rem; text-align: center; color: {{ '#22c55e' if (project.success_rate or 0) >= 90 else '#f59e0b' if (project.success_rate or 0) >= 70 else '#ef4444' }};">
                        {{ "%.1f"|format(project.success_rate or 0) }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Insights -->
<div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1.5rem; border-radius: 8px; margin-top: 2rem;">
    <h4 style="margin: 0 0 1rem 0; color: #1e40af;">ğŸ’¡ Key Insights</h4>
    <ul style="margin: 0; padding-left: 1.5rem; color: #1e40af; line-height: 1.8;">
        <li><strong>Parallel Collection</strong> enables simultaneous metrics gathering across all {{ project_count }} projects</li>
        <li><strong>Comparative Analysis</strong> identifies best practices from top performers</li>
        <li><strong>Outlier Detection</strong> flags projects needing immediate attention (>2 std dev)</li>
        <li><strong>Performance-Enabled</strong>: REST API 3-10x speedup makes cross-project analysis practical</li>
        <li><strong>Data-Driven Decisions</strong>: Use rankings to guide improvement efforts and resource allocation</li>
    </ul>
</div>

<!-- Generation Info -->
<div style="margin-top: 2rem; padding: 1rem; background: #f9fafb; border-radius: 4px; font-size: 0.75rem; color: #6b7280;">
    Generated on {{ generation_date }} | Analyzing {{ project_count }} projects in parallel
</div>
{% endblock %}
