{% extends "dashboards/base_dashboard.html" %}

{% block title %}AI Contributions Dashboard{% endblock %}
{% block meta_description %}AI vs Human contributions tracking - Devin AI analysis{% endblock %}

{% block header_title %}ü§ñ AI Contributions Dashboard{% endblock %}
{% block header_subtitle %}Tracking Devin AI vs Human Development Contributions{% endblock %}
{% block footer_context %}AI Contributions Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Summary metrics grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .metric-card {
        background: var(--bg-card);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        border-left: 4px solid #8b5cf6;
    }

    [data-theme="light"] .metric-card {
        background: white;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .metric-card h3 {
        font-size: 0.9rem;
        color: var(--text-tertiary);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-card .value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .metric-card .label {
        font-size: 0.95rem;
        color: var(--text-secondary);
    }

    /* Chart sections */
    .chart-section {
        background: var(--bg-card);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 32px;
        margin-bottom: 30px;
    }

    [data-theme="light"] .chart-section {
        background: white;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .chart-section h2 {
        font-size: 1.5rem;
        margin-bottom: 24px;
        color: var(--text-primary);
    }

    .chart-container {
        position: relative;
        height: 400px;
    }

    /* Table styling */
    .table-container {
        background: var(--bg-card);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 32px;
        overflow-x: auto;
    }

    [data-theme="light"] .table-container {
        background: white;
        box-shadow: 0 2px 8px var(--shadow);
    }

    .table-container table {
        width: 100%;
        border-collapse: collapse;
    }

    .table-container th {
        text-align: left;
        padding: 12px;
        border-bottom: 2px solid var(--border-color);
        color: var(--text-tertiary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table-container td {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-secondary);
    }

    .table-container tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    [data-theme="light"] .table-container tr:hover {
        background: rgba(0, 0, 0, 0.02);
    }

    /* Methodology section */
    .methodology-section {
        background: var(--bg-card);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 32px;
        margin-top: 30px;
    }

    .methodology-section h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: var(--text-primary);
    }

    .methodology-section h3 {
        font-size: 1.1rem;
        margin-top: 25px;
        margin-bottom: 12px;
        color: var(--text-primary);
    }

    .methodology-section p,
    .methodology-section li {
        color: var(--text-secondary);
        line-height: 1.8;
        margin-bottom: 15px;
    }

    .methodology-section ul {
        padding-left: 30px;
        margin-bottom: 20px;
    }

    .methodology-note {
        background: rgba(139, 92, 246, 0.1);
        border-left: 4px solid #8b5cf6;
        padding: 15px;
        border-radius: 6px;
        margin-top: 20px;
    }

    .methodology-note strong {
        color: var(--text-primary);
    }

    .methodology-note p {
        margin-top: 8px;
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Chart colors based on theme
    function getChartColors() {
        const theme = document.documentElement.getAttribute('data-theme');
        return {
            text: theme === 'dark' ? '#cbd5e1' : '#6b7280',
            grid: theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
            ai: '#8b5cf6',
            human: '#3b82f6'
        };
    }

    // AI vs Human Pie Chart
    const aiVsHumanCtx = document.getElementById('aiVsHumanChart').getContext('2d');
    let aiVsHumanChart = new Chart(aiVsHumanCtx, {
        type: 'doughnut',
        data: {
            labels: ['Devin AI', 'Human'],
            datasets: [{
                data: [{{ summary_stats.devin_prs }}, {{ summary_stats.human_prs }}],
                backgroundColor: ['#8b5cf6', '#3b82f6'],
                borderWidth: 2,
                borderColor: 'rgba(255, 255, 255, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: getChartColors().text,
                        font: { size: 14 }
                    }
                }
            }
        }
    });

    // Top Contributors Bar Chart
    const contributorsCtx = document.getElementById('contributorsChart').getContext('2d');
    let contributorsChart = new Chart(contributorsCtx, {
        type: 'bar',
        data: {
            labels: {{ author_labels|tojson }},
            datasets: [{
                label: 'PRs',
                data: {{ author_counts|tojson }},
                backgroundColor: '#8b5cf6',
                borderColor: '#8b5cf6',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: getChartColors().text },
                    grid: { color: getChartColors().grid }
                },
                x: {
                    ticks: {
                        color: getChartColors().text,
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Projects Chart
    const projectsCtx = document.getElementById('projectsChart').getContext('2d');
    const projectNames = {{ [p.name for p in project_items]|tojson }};
    const projectDevin = {{ [p.devin for p in project_items]|tojson }};
    const projectHuman = {{ [p.human for p in project_items]|tojson }};

    let projectsChart = new Chart(projectsCtx, {
        type: 'bar',
        data: {
            labels: projectNames,
            datasets: [
                {
                    label: 'Devin AI',
                    data: projectDevin,
                    backgroundColor: '#8b5cf6'
                },
                {
                    label: 'Human',
                    data: projectHuman,
                    backgroundColor: '#3b82f6'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: true,
                    ticks: { color: getChartColors().text },
                    grid: { color: getChartColors().grid }
                },
                x: {
                    stacked: true,
                    ticks: {
                        color: getChartColors().text,
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: getChartColors().text,
                        font: { size: 14 }
                    }
                }
            }
        }
    });

    // Update charts on theme change
    function updateCharts() {
        const colors = getChartColors();

        [aiVsHumanChart, contributorsChart, projectsChart].forEach(chart => {
            if (chart.options.plugins?.legend) {
                chart.options.plugins.legend.labels.color = colors.text;
            }
            if (chart.options.scales?.y) {
                chart.options.scales.y.ticks.color = colors.text;
                chart.options.scales.y.grid.color = colors.grid;
            }
            if (chart.options.scales?.x) {
                chart.options.scales.x.ticks.color = colors.text;
            }
            chart.update();
        });
    }

    // Hook into theme toggle to update charts
    const originalToggleTheme = window.toggleTheme;
    window.toggleTheme = function() {
        originalToggleTheme();
        updateCharts();
    };
</script>
{% endblock %}

{% block content %}
<!-- Summary Metrics -->
<div class="metrics-grid">
    <div class="metric-card" style="border-left-color: #8b5cf6;">
        <h3>Devin AI PRs</h3>
        <div class="value">{{ summary_stats.devin_prs }}</div>
        <div class="label">{{ summary_stats.devin_percentage|format_percent }}% of total</div>
    </div>

    <div class="metric-card" style="border-left-color: #3b82f6;">
        <h3>Human PRs</h3>
        <div class="value">{{ summary_stats.human_prs }}</div>
        <div class="label">{{ (100 - summary_stats.devin_percentage)|format_percent }}% of total</div>
    </div>

    <div class="metric-card" style="border-left-color: #10b981;">
        <h3>Total PRs</h3>
        <div class="value">{{ summary_stats.total_prs }}</div>
        <div class="label">Last 90 days</div>
    </div>

    <div class="metric-card" style="border-left-color: #f59e0b;">
        <h3>Contributors</h3>
        <div class="value">{{ summary_stats.author_count }}</div>
        <div class="label">Unique authors</div>
    </div>
</div>

<!-- Devin vs Human Chart -->
<div class="chart-section">
    <h2>AI vs Human Contributions</h2>
    <div class="chart-container">
        <canvas id="aiVsHumanChart"></canvas>
    </div>
</div>

<!-- Top Contributors Chart -->
<div class="chart-section">
    <h2>Top Contributors</h2>
    <div class="chart-container">
        <canvas id="contributorsChart"></canvas>
    </div>
</div>

<!-- Project Breakdown Chart -->
<div class="chart-section">
    <h2>Devin Contributions by Project</h2>
    <div class="chart-container">
        <canvas id="projectsChart"></canvas>
    </div>
</div>

<!-- Recent Devin PRs Table -->
<div class="table-container">
    <h2 style="margin-bottom: 20px;">Recent Devin PRs</h2>
    <table>
        <thead>
            <tr>
                <th>PR ID</th>
                <th>Project</th>
                <th>Title</th>
                <th>Author</th>
                <th>Commits</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for pr in recent_prs %}
            <tr>
                <td>#{{ pr.pr_id }}</td>
                <td>{{ pr.project }}</td>
                <td style="max-width: 400px; white-space: normal;">{{ pr.title }}</td>
                <td>{{ pr.created_by }}</td>
                <td>{{ pr.commit_count }}</td>
                <td>{{ pr.created_date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Data Collection Methodology -->
<div class="methodology-section">
    <h2>üìä Data Collection Methodology</h2>
    <p>
        This dashboard analyzes pull request authorship to identify AI-generated vs human-generated contributions.
        The statistics shown are based on the following data collection approach:
    </p>

    <h3>Detection Criteria</h3>
    <p>
        A pull request is classified as "Devin AI" if <strong>any</strong> of the following indicators are present:
    </p>
    <ul>
        <li><strong>Author name</strong> contains "devin" (case-insensitive)
            <br><em style="font-size: 0.9rem; color: var(--text-tertiary);">Example: "Devin Azure DevOps Integration", "Devin AI"</em>
        </li>
        <li><strong>Author email</strong> contains "devin"
            <br><em style="font-size: 0.9rem; color: var(--text-tertiary);">Example: "devin.azuredevopsintegration@theaccessgroup.com"</em>
        </li>
        <li><strong>Branch name</strong> contains "devin"
            <br><em style="font-size: 0.9rem; color: var(--text-tertiary);">Example: "refs/heads/devin/1766033274-add-feeearner-email-update-departmentid"</em>
        </li>
        <li><strong>PR title or description</strong> explicitly mentions "Devin"</li>
    </ul>

    <h3>Data Sources</h3>
    <ul>
        <li><strong>Source:</strong> Azure DevOps Git API</li>
        <li><strong>Timeframe:</strong> Last 90 days of completed pull requests</li>
        <li><strong>Scope:</strong> All active projects across the organization</li>
        <li><strong>Limit:</strong> Up to 200 most recent PRs per repository (top 5 repos per project)</li>
    </ul>

    <h3>Known Limitations</h3>
    <ul>
        <li>PRs where Devin initiated work but a human created the PR may be misclassified as "Human"</li>
        <li>Custom Devin configurations with different naming patterns may not be detected</li>
        <li>Historical PRs beyond 90 days are not included in current analysis</li>
        <li>PRs in archived or disabled repositories are excluded</li>
    </ul>

    <h3>Verification Steps</h3>
    <p>To verify these statistics with your teams:</p>
    <ul>
        <li>Cross-reference PR counts with Azure DevOps PR history for specific projects</li>
        <li>Check individual PR authors in Azure DevOps to confirm Devin identification</li>
        <li>Review the "Recent Devin PRs" table above for sample data validation</li>
        <li>Examine branch naming patterns in your repositories for Devin conventions</li>
    </ul>

    <div class="methodology-note">
        <strong>üìù Note for Team Review:</strong>
        <p>
            These statistics are automatically collected from Azure DevOps. Please review with your teams to ensure
            the Devin detection criteria align with your organization's Devin usage patterns. If you use custom
            Devin configurations or naming conventions, the detection rules may need adjustment.
        </p>
    </div>
</div>
{% endblock %}
