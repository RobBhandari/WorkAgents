{% extends "dashboards/base_dashboard.html" %}

{% block title %}Deployment Dashboard - DORA Metrics{% endblock %}
{% block meta_description %}DORA deployment metrics - deployment frequency, build success rate, and lead time{% endblock %}

{% block header_title %}Deployment Dashboard{% endblock %}
{% block header_subtitle %}DORA Metrics - Deployment Performance{% endblock %}
{% block footer_context %}Deployment Dashboard â€¢ Data source: Azure DevOps{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODERN MINIMALIST - Refined Dashboard Styling
   Design Direction: Clean, Refined, Professional
   Inspiration: Stripe, Linear, Modern SaaS dashboards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
    --color-slate-50: #f8fafc;
    --color-slate-100: #f1f5f9;
    --color-slate-200: #e2e8f0;
    --color-slate-300: #cbd5e1;
    --color-slate-400: #94a3b8;
    --color-slate-500: #64748b;
    --color-slate-600: #475569;
    --color-slate-700: #334155;
    --color-slate-800: #1e293b;
    --color-slate-900: #0f172a;

    --color-blue-400: #60a5fa;
    --color-blue-500: #3b82f6;
    --color-blue-600: #2563eb;

    --color-emerald-500: #10b981;
    --color-amber-500: #f59e0b;
    --color-red-500: #ef4444;

    --header-gradient-start: var(--color-slate-900) !important;
    --header-gradient-end: var(--color-slate-900) !important;
}

/* Refined typography - Inter with OpenType features */
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    background: var(--color-slate-900) !important;
    color: #ffffff !important;
    font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Sophisticated header */
body .header,
.container .header,
div.header {
    background: var(--color-slate-900) !important;
    border: none !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 64px 32px !important;
}

.header h1 {
    font-weight: 600 !important;
    letter-spacing: -0.02em !important;
    color: #ffffff !important;
    text-transform: none !important;
    font-size: 2.5rem !important;
}

.header p,
.header .subtitle {
    color: var(--color-slate-400) !important;
    font-weight: 400 !important;
    text-transform: none !important;
    letter-spacing: 0 !important;
}

/* Summary Cards - Refined with subtle borders */
.summary-card,
.card {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 24px !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.summary-card:hover,
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3) !important;
    border-color: rgba(59, 130, 246, 0.3) !important;
}

/* Tables - Refined styling */
table {
    border-collapse: collapse !important;
}

th {
    background: var(--color-slate-800) !important;
    color: var(--color-slate-400) !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    padding: 14px 16px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
}

tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    transition: background-color 0.2s ease !important;
}

tbody tr:hover {
    background: rgba(255, 255, 255, 0.02) !important;
}

td {
    padding: 12px 16px !important;
    color: #ffffff !important;
}

/* Preserve chevron spacing for expandable rows */
tbody tr.data-row td:first-child {
    padding-left: 30px !important;
}

tbody tr.data-row td:first-child::before {
    content: 'â–¶';
    position: absolute;
    left: 12px;
    font-size: 0.7rem;
    color: var(--color-slate-400);
    transition: transform 0.3s ease;
}

tbody tr.data-row.expanded td:first-child::before {
    transform: rotate(90deg);
}

/* Status badges - Refined colors */
.status-good { color: var(--color-emerald-500) !important; }
.status-caution { color: var(--color-amber-500) !important; }
.status-action { color: var(--color-red-500) !important; }
.status-inactive { color: var(--color-slate-500) !important; }

/* Detail rows - Refined styling */
.detail-row {
    display: none;
}

.detail-row.show {
    display: table-row;
}

.detail-content {
    background: var(--color-slate-800) !important;
    padding: 24px !important;
    border-left: 2px solid rgba(59, 130, 246, 0.3) !important;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h3,
.detail-section h4 {
    color: #ffffff !important;
    margin-bottom: 12px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.detail-metric {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 16px !important;
    color: var(--color-slate-300) !important;
}

.detail-metric-label {
    font-size: 0.75rem !important;
    text-transform: uppercase !important;
    color: var(--color-slate-400) !important;
    margin-bottom: 8px !important;
    letter-spacing: 0.05em !important;
}

.detail-metric-value {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    color: #ffffff !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIGHT THEME SUPPORT - Complete styling for light mode
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

[data-theme="light"] body {
    background: #ffffff !important;
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header {
    background: #ffffff !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] .header h1 {
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header p,
[data-theme="light"] .header .subtitle {
    color: var(--color-slate-600) !important;
}

[data-theme="light"] .summary-card,
[data-theme="light"] .card {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03) !important;
}

[data-theme="light"] .summary-card:hover,
[data-theme="light"] .card:hover {
    border-color: var(--color-blue-400) !important;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05) !important;
}

[data-theme="light"] th {
    background: var(--color-slate-100) !important;
    color: var(--color-slate-700) !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr {
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr:hover {
    background: var(--color-slate-50) !important;
}

[data-theme="light"] td {
    color: var(--color-slate-900) !important;
}

/* Detail rows - Light Mode */
[data-theme="light"] .detail-content {
    background: var(--color-slate-100) !important;
}

[data-theme="light"] .detail-metric {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
}

[data-theme="light"] .detail-metric-value {
    color: var(--color-slate-900) !important;
}

/* Chevron - Light Mode */
[data-theme="light"] tbody tr.data-row td:first-child::before {
    color: var(--color-slate-600) !important;
}

/* Footer - Light Mode */
[data-theme="light"] .footer p {
    color: var(--color-slate-600) !important;
}
</style>

{% endblock %}

{% block content %}
<!-- Summary metrics -->
<div class="section">
    <h2>Overview</h2>
    <div class="summary-grid">
        {% for card in summary_cards %}
        {{ card|safe }}
        {% endfor %}
    </div>
</div>

<!-- Deployment metrics table -->
<div class="section">
    <h2>Deployment Metrics by Project</h2>
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Project</th>
                    <th>Deployment Frequency</th>
                    <th>Build Success Rate</th>
                    <th>Build Duration (Median)</th>
                    <th>Lead Time (Median)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
            {% for project in projects %}
                <tr class="data-row parent-row{% if project.children %} expandable{% endif %}"
                    {% if project.children %}onclick="toggleRow(this)"{% endif %}>
                    <td>
                        {% if project.children %}
                        <span class="expand-icon">â–¶</span>
                        {% endif %}
                        <strong>{{ project.name }}</strong>
                    </td>
                    <td title="{{ project.deploys_tooltip }}">{{ project.deploys_display }}</td>
                    <td title="{{ project.success_tooltip }}">{{ project.success_display }}</td>
                    <td title="{{ project.duration_tooltip }}">{{ project.duration_display }}</td>
                    <td title="{{ project.lead_time_tooltip }}">{{ project.lead_time_display }}</td>
                    <td>
                        <span class="status-{{ project.status_class }}" title="{{ project.status_tooltip }}">
                            {{ project.status_display }}
                        </span>
                    </td>
                </tr>
                {% if project.children %}
                    <tr class="detail-row" style="display: none;">
                        <td colspan="6" class="detail-cell">
                            <div class="pipeline-details">
                                <h4 class="pipeline-details-title">Pipeline Build Statistics</h4>
                                <table class="pipeline-table">
                                    <thead>
                                        <tr>
                                            <th>Pipeline</th>
                                            <th>Total Builds</th>
                                            <th>Succeeded</th>
                                            <th>Failed</th>
                                            <th>Canceled</th>
                                            <th>Success Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for child in project.children %}
                                        <tr>
                                            <td class="pipeline-name">{{ child.pipeline_name }}</td>
                                            <td>{{ child.total_builds }}</td>
                                            <td class="success-count">{{ child.succeeded }}</td>
                                            <td class="failed-count">{{ child.failed }}</td>
                                            <td class="canceled-count">{{ child.canceled }}</td>
                                            <td class="success-rate">{{ child.success_rate_pct|round(1) }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Glossary -->
<script>
// Custom toggleRow function for expandable pipeline details
function toggleRow(row) {
    const isExpanded = row.classList.contains('expanded');

    // Toggle expanded class on parent row (for icon rotation)
    row.classList.toggle('expanded');

    // Find the detail row (next sibling)
    const detailRow = row.nextElementSibling;
    if (detailRow && detailRow.classList.contains('detail-row')) {
        if (isExpanded) {
            detailRow.style.display = 'none';
        } else {
            detailRow.style.display = 'table-row';
        }
    }
}
</script>

{% if show_glossary %}
<div class="glossary">
    <div class="glossary-header" onclick="toggleGlossary()">
        <h3>ğŸ“– What These Metrics Mean</h3>
        <span class="glossary-toggle" id="glossary-toggle">â–¼</span>
    </div>
    <div class="glossary-content" id="glossary-content">
        <div class="glossary-item">
            <div class="glossary-term">Status Indicator</div>
            <div class="glossary-definition">
                Overall health of the deployment pipeline based on success rate and activity:<br><br>
                <span style="color: #10b981;">âœ“ <strong>Good</strong></span>: â‰¥90% success rate + â‰¥1 deploy/week<br>
                <span style="color: #f59e0b;">âš  <strong>Caution</strong></span>: â‰¥70% success rate + â‰¥0.5 deploys/week<br>
                <span style="color: #ef4444;">â— <strong>Action Needed</strong></span>: Low success rate or infrequent deployments<br>
                <span style="color: #94a3b8;">â—‹ <strong>Inactive</strong></span>: No deployments in the last 90 days
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">DORA Metrics</div>
            <div class="glossary-definition">
                DevOps Research and Assessment (DORA) metrics are industry-standard measures of software delivery performance.
                These metrics help teams understand their deployment velocity, stability, and efficiency.
                Research shows that high-performing teams excel across all four DORA metrics.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Deployment Frequency</div>
            <div class="glossary-definition">
                How often code is successfully deployed to production. Measured as deployments per week.
                <strong>Higher is better</strong> - more frequent deployments indicate better agility and faster delivery of value to customers.
                <br><br>
                Elite performers: Multiple deployments per day<br>
                High performers: Daily to weekly deployments<br>
                Medium performers: Weekly to monthly deployments
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Build Success Rate</div>
            <div class="glossary-definition">
                Percentage of builds that complete successfully without failures.
                <strong>Higher is better</strong> - indicates code quality, test coverage, and build stability.
                <br><br>
                A high success rate (>90%) suggests robust testing and quality gates.
                Low success rates can indicate flaky tests, infrastructure issues, or code quality problems.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Build Duration (Median)</div>
            <div class="glossary-definition">
                The median time it takes to complete a build, measured in minutes.
                <strong>Lower is better</strong> - faster builds mean quicker feedback for developers.
                <br><br>
                We show both median (typical time) and P85 (85th percentile) to account for variability.
                Long build times can slow down development velocity and delay feedback on code changes.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Lead Time for Changes</div>
            <div class="glossary-definition">
                The time from when code is committed to when it's successfully deployed to production, measured in hours.
                <strong>Lower is better</strong> - shorter lead times mean faster response to customer needs and market changes.
                <br><br>
                Elite performers: Less than 1 hour<br>
                High performers: 1 day to 1 week<br>
                Medium performers: 1 week to 1 month
                <br><br>
                This metric combines build time, test time, approval processes, and deployment time.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">P85 (85th Percentile)</div>
            <div class="glossary-definition">
                A statistical measure showing the value below which 85% of observations fall.
                This helps filter out extreme outliers while capturing realistic upper bounds.
                <br><br>
                For example, if P85 build duration is 15 minutes, it means 85% of builds complete in 15 minutes or less.
            </div>
        </div>

        <h3 style="margin-top: 30px; color: #667eea;">ğŸ“Š Data Collection Details</h3>

        <div class="glossary-item">
            <div class="glossary-term">Time Period</div>
            <div class="glossary-definition">
                <strong>90-day lookback period</strong> for all deployment metrics.
                This provides enough data for meaningful statistics while remaining relevant to current performance.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Build Criteria</div>
            <div class="glossary-definition">
                Only completed builds (succeeded or failed) are counted.
                Canceled or in-progress builds are excluded from metrics.
                Deployment frequency counts only successful builds.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Why These Metrics Matter</div>
            <div class="glossary-definition">
                DORA metrics correlate strongly with organizational performance and business outcomes.
                Teams that excel in these metrics deliver more value, respond faster to incidents,
                and have higher job satisfaction. These are <strong>leading indicators</strong> of overall engineering effectiveness.
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
