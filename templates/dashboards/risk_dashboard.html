{% extends "dashboards/base_dashboard.html" %}

{% block title %}Delivery Risk Dashboard{% endblock %}
{% block meta_description %}Change Stability & Risk Signals - Director Observatory{% endblock %}

{% block header_title %}Delivery Risk Dashboard{% endblock %}
{% block header_subtitle %}Change Stability & Risk Signals{% endblock %}
{% block header_metadata %}Week {{ week_number }} â€¢ {{ week_date }} â€¢ Generated {{ generation_date }}{% endblock %}
{% block footer_context %}Delivery Risk Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Minimalist Design - Inter Font + Solid Slate Colors */
    /* IMPORTANT: Override framework styles with !important */

    :root {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
        font-feature-settings: 'ss01', 'cv11', 'cv05';
    }

    /* Override framework header with solid slate background */
    .header {
        background: linear-gradient(135deg, #334155 0%, #1e293b 100%) !important;
        border-radius: 12px !important;
        padding: 2.5rem !important;
        margin-bottom: 2rem !important;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2) !important;
    }

    [data-theme="light"] .header {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%) !important;
        box-shadow: 0 4px 6px -1px rgb(15 23 42 / 0.1) !important;
    }

    .header h1 {
        color: #f1f5f9 !important;
        font-size: 2.5rem !important;
        font-weight: 700 !important;
        margin: 0 0 0.5rem 0 !important;
        letter-spacing: -0.025em !important;
    }

    [data-theme="light"] .header h1 {
        color: #0f172a !important;
    }

    .header .subtitle {
        color: #cbd5e1 !important;
        font-size: 1.125rem !important;
    }

    [data-theme="light"] .header .subtitle {
        color: #475569 !important;
    }

    .header p {
        color: #94a3b8 !important;
        font-size: 0.875rem !important;
    }

    [data-theme="light"] .header p {
        color: #64748b !important;
    }

    /* Dark theme colors (solid slate) */
    [data-theme="dark"] {
        --exec-bg: #1e293b;
        --card-bg: #1e293b;
        --card-hover: #334155;
        --detail-bg: #334155;
        --glossary-bg: #1e293b;
        --glossary-hover: #334155;
        --border: #475569;
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.2);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3);
    }

    /* Light theme colors (solid slate) */
    [data-theme="light"] {
        --exec-bg: #f8fafc;
        --card-bg: #ffffff;
        --card-hover: #f1f5f9;
        --detail-bg: #f8fafc;
        --glossary-bg: #f8fafc;
        --glossary-hover: #e2e8f0;
        --border: #cbd5e1;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --shadow-sm: 0 1px 2px 0 rgb(15 23 42 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(15 23 42 / 0.1);
    }

    /* Override framework body and container */
    body {
        background: #0f172a !important;
        font-family: 'Inter', sans-serif !important;
    }

    [data-theme="light"] body {
        background: #f8fafc !important;
    }

    .container {
        background: transparent !important;
    }

    /* Dashboard-specific styles */
    .executive-summary {
        background: var(--bg-secondary);
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px var(--shadow);
        transition: background-color 0.3s ease;
    }

    .status-badge {
        background: {{ status_color }};
    }

    .summary-card {
        border-left-color: #f59e0b;
    }

    /* Detail content customization for Risk Dashboard */
    .detail-section {
        margin-bottom: 16px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin: 12px 0;
    }

    .detail-metric {
        background: var(--bg-secondary);
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #f59e0b;
    }

    .detail-metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
    }

    .detail-metric-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .detail-list {
        list-style: none;
        padding: 0;
        margin: 8px 0;
    }

    .detail-list li {
        padding: 8px;
        background: var(--bg-secondary);
        margin-bottom: 6px;
        border-radius: 4px;
        font-size: 0.85rem;
        border-left: 2px solid #ef4444;
    }

    .no-data {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 0.9rem;
    }

    .alert-box {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 16px;
        border-radius: 6px;
        margin: 20px 0;
    }

    .alert-box .alert-title {
        font-weight: 600;
        color: #92400e;
        margin-bottom: 8px;
    }

    .alert-box .alert-message {
        font-size: 0.9rem;
        color: #78350f;
        line-height: 1.5;
    }
</style>
{% endblock %}

{% block content %}
<!-- Executive Summary -->
<div class="executive-summary">
    <h2 style="margin-bottom: 10px;">Executive Summary</h2>
    <p style="color: var(--text-secondary); margin-bottom: 20px;">
        Code activity metrics across {{ project_count }} projects. All metrics based on actual commit data from Git repositories.
    </p>

    <div class="summary-grid">
        {% for card in summary_cards %}
        {{ card|safe }}
        {% endfor %}
    </div>
</div>

<!-- Project Activity Table -->
<div class="section">
    <h2>Project Activity Summary</h2>
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Project</th>
                    <th>Commits (90d)</th>
                    <th>Files Changed</th>
                    <th>Single Owner %</th>
                    <th>Coupled Pairs</th>
                    <th>Activity Level</th>
                </tr>
            </thead>
            <tbody>
            {% for project in projects %}
                <tr class="data-row clickable" onclick="toggleDetail('detail-{{ loop.index }}', this)">
                    <td>{{ project.name }}</td>
                    <td>{{ project.commits|format_number }}</td>
                    <td>{{ project.files|format_number }}</td>
                    <td title="{{ project.knowledge_title }}">{{ project.knowledge_display }}</td>
                    <td title="{{ project.coupling_title }}">{{ project.coupling_display }}</td>
                    <td title="{{ project.activity_tooltip }}">{{ project.activity_level|safe }}</td>
                </tr>
                <tr id="detail-{{ loop.index }}" class="detail-row">
                    <td colspan="6">
                        <div class="detail-content">
                            {{ project.drilldown_html|safe }}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Glossary -->
<div class="glossary">
    <div class="glossary-header" onclick="toggleGlossary()">
        <h3>ðŸ“– What These Metrics Mean</h3>
        <span class="glossary-toggle" id="glossary-toggle">â–¼</span>
    </div>
    <div class="glossary-content" id="glossary-content">
        <div class="glossary-item">
            <div class="glossary-term">Commits</div>
            <div class="glossary-definition">
                Individual code changes committed to Git repositories. Each commit represents a discrete change to the codebase.
                <br><strong>What high commit counts mean:</strong> More active development, more features being built, or more bugs being fixed.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Files Changed</div>
            <div class="glossary-definition">
                Unique files that have been modified at least once in the time period. Calculated by tracking which files
                appear in commit diffs. This is <strong>actual file change data</strong> from Git repositories.
                <br><strong>What this tells you:</strong> Scope of changes across the codebase.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Single Owner % (Knowledge Distribution)</div>
            <div class="glossary-definition">
                Percentage of files that have been modified by only one developer in the last 90 days.
                This is a "bus factor" metric - files with only one contributor represent knowledge concentration risk.
                <br><br>
                <strong>What this means:</strong>
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li><strong>High %:</strong> More files depend on single individuals (higher risk)</li>
                    <li><strong>Low %:</strong> Knowledge is more distributed (lower risk)</li>
                </ul>
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Coupled Pairs (Module Coupling)</div>
            <div class="glossary-definition">
                Number of file pairs that have been changed together in commits 3 or more times.
                Files that change together frequently may indicate tight coupling, shared concerns, or architectural dependencies.
                <br><br>
                <strong>What high coupling means:</strong>
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li>Changes in one area ripple to other areas</li>
                    <li>Refactoring becomes more complex</li>
                    <li>Testing requires broader scope</li>
                </ul>
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Code Churn / Hot Paths</div>
            <div class="glossary-definition">
                Files that are changed most frequently. High churn files are modified repeatedly and may indicate:
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li>Core shared code used by many features</li>
                    <li>Unstable requirements or frequent bug fixes</li>
                    <li>Areas needing refactoring or better abstraction</li>
                </ul>
                <strong>Data Source:</strong> Actual file paths from Git commit diffs
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Activity Level</div>
            <div class="glossary-definition">
                Classification based on commit count:
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li><strong>High Activity:</strong> 100+ commits (very active development)</li>
                    <li><strong>Medium Activity:</strong> 20-99 commits (moderate development)</li>
                    <li><strong>Low Activity:</strong> &lt;20 commits (minimal changes)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
