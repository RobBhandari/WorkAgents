{% extends "dashboards/base_dashboard.html" %}

{% block title %}Delivery Risk Dashboard{% endblock %}
{% block meta_description %}Change Stability & Risk Signals - Director Observatory{% endblock %}

{% block header_title %}Delivery Risk Dashboard{% endblock %}
{% block header_subtitle %}Change Stability & Risk Signals{% endblock %}
{% block header_metadata %}Week {{ week_number }} â€¢ {{ week_date }} â€¢ Generated {{ generation_date }}{% endblock %}
{% block footer_context %}Delivery Risk Dashboard{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODERN MINIMALIST - Refined Dashboard Styling
   Design Direction: Clean, Refined, Professional
   Inspiration: Stripe, Linear, Modern SaaS dashboards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
    --color-slate-50: #f8fafc;
    --color-slate-100: #f1f5f9;
    --color-slate-200: #e2e8f0;
    --color-slate-300: #cbd5e1;
    --color-slate-400: #94a3b8;
    --color-slate-500: #64748b;
    --color-slate-600: #475569;
    --color-slate-700: #334155;
    --color-slate-800: #1e293b;
    --color-slate-900: #0f172a;

    --color-blue-400: #60a5fa;
    --color-blue-500: #3b82f6;
    --color-blue-600: #2563eb;

    --color-emerald-500: #10b981;
    --color-amber-500: #f59e0b;
    --color-red-500: #ef4444;

    --header-gradient-start: var(--color-slate-900) !important;
    --header-gradient-end: var(--color-slate-900) !important;
}

/* Refined typography - Inter with OpenType features */
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    background: var(--color-slate-900) !important;
    color: #ffffff !important;
    font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Sophisticated header */
body .header,
.container .header,
div.header {
    background: var(--color-slate-900) !important;
    border: none !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 64px 32px !important;
}

.header h1 {
    font-weight: 600 !important;
    letter-spacing: -0.02em !important;
    color: #ffffff !important;
    text-transform: none !important;
    font-size: 2.5rem !important;
}

.header p,
.header .subtitle {
    color: var(--color-slate-400) !important;
    font-weight: 400 !important;
    text-transform: none !important;
    letter-spacing: 0 !important;
}

/* Summary Cards - Refined with subtle borders */
.summary-card,
.card {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 24px !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.summary-card:hover,
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3) !important;
    border-color: rgba(59, 130, 246, 0.3) !important;
}

/* Tables - Refined styling */
table {
    border-collapse: collapse !important;
}

th {
    background: var(--color-slate-800) !important;
    color: var(--color-slate-400) !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    padding: 14px 16px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
}

tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    transition: background-color 0.2s ease !important;
}

tbody tr:hover {
    background: rgba(255, 255, 255, 0.02) !important;
}

td {
    padding: 12px 16px !important;
    color: #ffffff !important;
}

/* Status badges - Refined colors */
.status-good { color: var(--color-emerald-500) !important; }
.status-caution { color: var(--color-amber-500) !important; }
.status-action { color: var(--color-red-500) !important; }
.status-inactive { color: var(--color-slate-500) !important; }

/* Detail rows - Refined styling */
.detail-row {
    display: none;
}

.detail-row.show {
    display: table-row;
}

.detail-content {
    background: var(--color-slate-800) !important;
    padding: 24px !important;
    border-left: 2px solid rgba(59, 130, 246, 0.3) !important;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h3,
.detail-section h4 {
    color: #ffffff !important;
    margin-bottom: 12px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.detail-metric {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 16px !important;
    color: var(--color-slate-300) !important;
}

.detail-metric-label {
    font-size: 0.75rem !important;
    text-transform: uppercase !important;
    color: var(--color-slate-400) !important;
    margin-bottom: 8px !important;
    letter-spacing: 0.05em !important;
}

.detail-metric-value {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    color: #ffffff !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIGHT THEME SUPPORT - Complete styling for light mode
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

[data-theme="light"] body {
    background: #ffffff !important;
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header {
    background: #ffffff !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] .header h1 {
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header p,
[data-theme="light"] .header .subtitle {
    color: var(--color-slate-600) !important;
}

[data-theme="light"] .summary-card,
[data-theme="light"] .card {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03) !important;
}

[data-theme="light"] .summary-card:hover,
[data-theme="light"] .card:hover {
    border-color: var(--color-blue-400) !important;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05) !important;
}

[data-theme="light"] th {
    background: var(--color-slate-100) !important;
    color: var(--color-slate-700) !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr {
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr:hover {
    background: var(--color-slate-50) !important;
}

[data-theme="light"] td {
    color: var(--color-slate-900) !important;
}

/* Detail rows - Light Mode */
[data-theme="light"] .detail-content {
    background: var(--color-slate-100) !important;
}

[data-theme="light"] .detail-metric {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
}

[data-theme="light"] .detail-metric-value {
    color: var(--color-slate-900) !important;
}

/* Footer - Light Mode */
[data-theme="light"] .footer p {
    color: var(--color-slate-600) !important;
}
</style>

{% endblock %}

{% block content %}
<!-- Executive Summary -->
<div class="executive-summary">
    <h2 style="margin-bottom: 10px;">Executive Summary</h2>
    <p style="color: var(--text-secondary); margin-bottom: 20px;">
        Code activity metrics across {{ project_count }} projects. All metrics based on actual commit data from Git repositories.
    </p>

    <div class="summary-grid">
        {% for card in summary_cards %}
        {{ card|safe }}
        {% endfor %}
    </div>
</div>

<!-- Project Activity Table -->
<div class="section">
    <h2>Project Activity Summary</h2>
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Project</th>
                    <th>Commits (90d)</th>
                    <th>Files Changed</th>
                    <th>Single Owner %</th>
                    <th>Coupled Pairs</th>
                    <th>Activity Level</th>
                </tr>
            </thead>
            <tbody>
            {% for project in projects %}
                <tr class="data-row clickable" onclick="toggleDetail('detail-{{ loop.index }}', this)">
                    <td>{{ project.name }}</td>
                    <td>{{ project.commits|format_number }}</td>
                    <td>{{ project.files|format_number }}</td>
                    <td title="{{ project.knowledge_title }}">{{ project.knowledge_display }}</td>
                    <td title="{{ project.coupling_title }}">{{ project.coupling_display }}</td>
                    <td title="{{ project.activity_tooltip }}">{{ project.activity_level|safe }}</td>
                </tr>
                <tr id="detail-{{ loop.index }}" class="detail-row">
                    <td colspan="6">
                        <div class="detail-content">
                            {{ project.drilldown_html|safe }}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Glossary -->
<div class="glossary">
    <div class="glossary-header" onclick="toggleGlossary()">
        <h3>ğŸ“– What These Metrics Mean</h3>
        <span class="glossary-toggle" id="glossary-toggle">â–¼</span>
    </div>
    <div class="glossary-content" id="glossary-content">
        <div class="glossary-item">
            <div class="glossary-term">Commits</div>
            <div class="glossary-definition">
                Individual code changes committed to Git repositories. Each commit represents a discrete change to the codebase.
                <br><strong>What high commit counts mean:</strong> More active development, more features being built, or more bugs being fixed.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Files Changed</div>
            <div class="glossary-definition">
                Unique files that have been modified at least once in the time period. Calculated by tracking which files
                appear in commit diffs. This is <strong>actual file change data</strong> from Git repositories.
                <br><strong>What this tells you:</strong> Scope of changes across the codebase.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Single Owner % (Knowledge Distribution)</div>
            <div class="glossary-definition">
                Percentage of files that have been modified by only one developer in the last 90 days.
                This is a "bus factor" metric - files with only one contributor represent knowledge concentration risk.
                <br><br>
                <strong>What this means:</strong>
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li><strong>High %:</strong> More files depend on single individuals (higher risk)</li>
                    <li><strong>Low %:</strong> Knowledge is more distributed (lower risk)</li>
                </ul>
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Coupled Pairs (Module Coupling)</div>
            <div class="glossary-definition">
                Number of file pairs that have been changed together in commits 3 or more times.
                Files that change together frequently may indicate tight coupling, shared concerns, or architectural dependencies.
                <br><br>
                <strong>What high coupling means:</strong>
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li>Changes in one area ripple to other areas</li>
                    <li>Refactoring becomes more complex</li>
                    <li>Testing requires broader scope</li>
                </ul>
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Code Churn / Hot Paths</div>
            <div class="glossary-definition">
                Files that are changed most frequently. High churn files are modified repeatedly and may indicate:
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li>Core shared code used by many features</li>
                    <li>Unstable requirements or frequent bug fixes</li>
                    <li>Areas needing refactoring or better abstraction</li>
                </ul>
                <strong>Data Source:</strong> Actual file paths from Git commit diffs
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Activity Level</div>
            <div class="glossary-definition">
                Classification based on commit count:
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li><strong>High Activity:</strong> 100+ commits (very active development)</li>
                    <li><strong>Medium Activity:</strong> 20-99 commits (moderate development)</li>
                    <li><strong>Low Activity:</strong> &lt;20 commits (minimal changes)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
