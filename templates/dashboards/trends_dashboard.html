{% extends "dashboards/base_dashboard.html" %}

{% block title %}Executive Trends{% endblock %}

{% block header_title %}Executive Trends Dashboard{% endblock %}
{% block header_subtitle %}Engineering Health Metrics{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard-specific styles */
    .view-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        align-items: center;
    }

    .view-label {
        font-weight: 600;
        color: var(--text-primary);
    }

    .view-btn {
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 20px;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .view-btn:hover {
        border-color: #667eea;
    }

    .view-btn.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
        font-weight: 600;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    @media (max-width: 1400px) {
        .metrics-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
    }

    .metric-card-link {
        display: block;
        text-decoration: none;
        color: inherit;
        height: 100%;
    }

    .metric-card {
        background: var(--bg-card);
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--shadow);
        border-left: 4px solid #667eea;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        height: 100%;
    }

    .metric-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.25);
        border-left-color: #764ba2;
        border-left-width: 6px;
    }

    .metric-card:active {
        transform: translateY(-4px) scale(1.01);
    }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .metric-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .metric-icon {
        font-size: 1.2rem;
    }

    .trend-indicator {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .trend-up { color: #ef4444; }
    .trend-down { color: #10b981; }
    .trend-stable { color: #f59e0b; }

    .metric-description {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 12px;
        line-height: 1.4;
        opacity: 0.9;
    }

    .metric-value {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .metric-change {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 15px;
    }

    .sparkline-container {
        height: 60px;
        margin-top: 15px;
        position: relative;
    }

    .sparkline {
        width: 100%;
        height: 100%;
    }

    .sparkline-tooltip {
        position: absolute;
        background: var(--bg-secondary);
        border: 2px solid #667eea;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease;
        white-space: nowrap;
        z-index: 100;
        box-shadow: 0 4px 12px var(--shadow);
    }

    .sparkline-tooltip.visible {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- View Selector -->
<div class="view-selector">
    <span class="view-label">View:</span>
    <button class="view-btn" onclick="changeView(4)">1 Month</button>
    <button class="view-btn active" onclick="changeView(12)">3 Months</button>
    <button class="view-btn" onclick="changeView(24)">6 Months</button>
</div>

<div class="metrics-grid" id="metrics-container">
    <!-- Metrics will be dynamically generated here -->
</div>
{% endblock %}

{% block footer %}
<p>Director Observatory â€¢ Executive Trends</p>
<p>Last updated: {{ timestamp }}</p>
<p style="opacity: 0.7; font-size: 0.85rem;">Data from Observatory history files</p>
{% endblock %}

{% block extra_js %}
<script>
    const trendsData = {{ metrics_json|safe }};
    let currentView = 12; // Default to 12 weeks

    function changeView(weeks) {
        currentView = weeks;

        // Update button states
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Re-render metrics with new view
        renderMetrics();
    }

    function generateSparkline(data, containerId, unit) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.warn('Container not found:', containerId);
            return;
        }

        // Slice data based on current view
        const viewData = data.slice(-currentView);

        // Validate data
        if (!viewData || viewData.length === 0) {
            console.warn('No data for sparkline:', containerId);
            return;
        }

        const width = container.offsetWidth;
        const height = 60;

        // Check if container has width
        if (width === 0) {
            console.warn('Container has no width:', containerId);
            return;
        }

        const max = Math.max(...viewData);
        const min = Math.min(...viewData);
        const range = max - min || 1;

        // Validate calculated values
        if (!isFinite(max) || !isFinite(min) || !isFinite(range)) {
            console.error('Invalid data values for sparkline:', containerId, { max, min, range, viewData });
            return;
        }

        // Create tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'sparkline-tooltip';
        container.appendChild(tooltip);

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        svg.setAttribute('class', 'sparkline');

        const points = viewData.map((value, index) => {
            const x = viewData.length > 1 ? (index / (viewData.length - 1)) * width : width / 2;
            const y = height - ((value - min) / range) * (height - 10) - 5;
            return `${x},${y}`;
        }).join(' ');

        // Gradient background
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', `gradient-${containerId}`);
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '0%');
        gradient.setAttribute('y2', '100%');

        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('style', 'stop-color:rgba(102,126,234,0.3);stop-opacity:1');

        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('style', 'stop-color:rgba(102,126,234,0);stop-opacity:1');

        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);

        // Area
        const area = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        area.setAttribute('points', `0,${height} ${points} ${width},${height}`);
        area.setAttribute('fill', `url(#gradient-${containerId})`);
        svg.appendChild(area);

        // Line
        const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
        polyline.setAttribute('points', points);
        polyline.setAttribute('fill', 'none');
        polyline.setAttribute('stroke', '#667eea');
        polyline.setAttribute('stroke-width', '2');
        svg.appendChild(polyline);

        // Dots with hover tooltips
        viewData.forEach((value, index) => {
            const x = (index / (viewData.length - 1)) * width;
            const y = height - ((value - min) / range) * (height - 10) - 5;

            // Create invisible larger hit area for easier targeting
            const hitArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            hitArea.setAttribute('cx', x);
            hitArea.setAttribute('cy', y);
            hitArea.setAttribute('r', '12');
            hitArea.setAttribute('fill', 'transparent');
            hitArea.style.cursor = 'pointer';

            // Create visible circle
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '4');
            circle.setAttribute('fill', '#667eea');
            circle.style.transition = 'r 0.2s ease';
            circle.style.pointerEvents = 'none'; // Let hit area handle events

            // Hover effects on hit area
            hitArea.addEventListener('mouseenter', (e) => {
                circle.setAttribute('r', '6');
                tooltip.textContent = `${value} ${unit}`;
                tooltip.classList.add('visible');

                // Position tooltip
                const containerRect = container.getBoundingClientRect();
                const circleRect = circle.getBoundingClientRect();
                tooltip.style.left = (circleRect.left - containerRect.left + circleRect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = (circleRect.top - containerRect.top - tooltip.offsetHeight - 8) + 'px';
            });

            hitArea.addEventListener('mouseleave', () => {
                circle.setAttribute('r', '4');
                tooltip.classList.remove('visible');
            });

            svg.appendChild(hitArea);
            svg.appendChild(circle);
        });

        container.appendChild(svg);
    }

    function renderMetrics() {
        const container = document.getElementById('metrics-container');
        container.innerHTML = '';

        trendsData.forEach(metric => {
            const containerId = `sparkline-${metric.id}`;

            // Create clickable link wrapper
            const link = document.createElement('a');
            link.href = metric.dashboardUrl;
            link.className = 'metric-card-link';

            const card = document.createElement('div');
            card.className = 'metric-card';
            card.innerHTML = `
                <div class="metric-header">
                    <div class="metric-title">
                        <span class="metric-icon">${metric.icon}</span>
                        ${metric.title}
                    </div>
                    <div class="trend-indicator ${metric.cssClass}">
                        ${metric.arrow}
                    </div>
                </div>
                <div class="metric-description">${metric.description}</div>
                <div class="metric-value" style="color: ${metric.ragColor};">${metric.current} <span style="font-size: 1rem; font-weight: normal; color: var(--text-secondary);">${metric.unit}</span></div>
                <div class="metric-change">
                    ${metric.change > 0 ? '+' : ''}${metric.change} ${metric.changeLabel}
                </div>
                <div class="sparkline-container" id="${containerId}"></div>
            `;

            link.appendChild(card);
            container.appendChild(link);

            // Generate sparkline after DOM is updated
            setTimeout(() => generateSparkline(metric.data, containerId, metric.unit), 0);
        });
    }

    // Initialize
    renderMetrics();
</script>
{% endblock %}
