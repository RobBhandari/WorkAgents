{% extends "dashboards/base_dashboard.html" %}

{% block title %}Executive Trends{% endblock %}

{% block header_title %}Executive Trends Dashboard{% endblock %}
{% block header_subtitle %}Engineering Health Metrics{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ═══════════════════════════════════════════════════════════════
   MODERN MINIMALIST - Refined Dashboard Styling
   Design Direction: Clean, Refined, Professional
   Inspiration: Stripe, Linear, Modern SaaS dashboards
   ═══════════════════════════════════════════════════════════════ */

:root {
    --color-slate-50: #f8fafc;
    --color-slate-100: #f1f5f9;
    --color-slate-200: #e2e8f0;
    --color-slate-300: #cbd5e1;
    --color-slate-400: #94a3b8;
    --color-slate-500: #64748b;
    --color-slate-600: #475569;
    --color-slate-700: #334155;
    --color-slate-800: #1e293b;
    --color-slate-900: #0f172a;

    --color-blue-400: #60a5fa;
    --color-blue-500: #3b82f6;
    --color-blue-600: #2563eb;

    --color-emerald-500: #10b981;
    --color-amber-500: #f59e0b;
    --color-red-500: #ef4444;

    --header-gradient-start: var(--color-slate-900) !important;
    --header-gradient-end: var(--color-slate-900) !important;
}

/* Refined typography - Inter with OpenType features */
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    background: var(--color-slate-900) !important;
    color: #ffffff !important;
    font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Sophisticated header */
body .header,
.container .header,
div.header {
    background: var(--color-slate-900) !important;
    border: none !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 64px 32px !important;
}

.header h1 {
    font-weight: 600 !important;
    letter-spacing: -0.02em !important;
    color: #ffffff !important;
    text-transform: none !important;
    font-size: 2.5rem !important;
}

.header p,
.header .subtitle {
    color: var(--color-slate-400) !important;
    font-weight: 400 !important;
    text-transform: none !important;
    letter-spacing: 0 !important;
}

/* Summary Cards - Refined with subtle borders */
.summary-card,
.card {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 24px !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.summary-card:hover,
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3) !important;
    border-color: rgba(59, 130, 246, 0.3) !important;
}

/* Tables - Refined styling */
table {
    border-collapse: collapse !important;
}

th {
    background: var(--color-slate-800) !important;
    color: var(--color-slate-400) !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    padding: 14px 16px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
}

tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    transition: background-color 0.2s ease !important;
}

tbody tr:hover {
    background: rgba(255, 255, 255, 0.02) !important;
}

td {
    padding: 12px 16px !important;
    color: #ffffff !important;
}

/* Status badges - Refined colors */
.status-good { color: var(--color-emerald-500) !important; }
.status-caution { color: var(--color-amber-500) !important; }
.status-action { color: var(--color-red-500) !important; }
.status-inactive { color: var(--color-slate-500) !important; }

/* ═══════════════════════════════════════════════════════════════
   LIGHT THEME SUPPORT - Complete styling for light mode
   ═══════════════════════════════════════════════════════════════ */

[data-theme="light"] body {
    background: #ffffff !important;
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header {
    background: #ffffff !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] .header h1 {
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header p,
[data-theme="light"] .header .subtitle {
    color: var(--color-slate-600) !important;
}

[data-theme="light"] .summary-card,
[data-theme="light"] .card {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03) !important;
}

[data-theme="light"] .summary-card:hover,
[data-theme="light"] .card:hover {
    border-color: var(--color-blue-400) !important;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05) !important;
}

[data-theme="light"] th {
    background: var(--color-slate-100) !important;
    color: var(--color-slate-700) !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr {
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr:hover {
    background: var(--color-slate-50) !important;
}

[data-theme="light"] td {
    color: var(--color-slate-900) !important;
}

/* Footer - Light Mode */
[data-theme="light"] .footer p {
    color: var(--color-slate-600) !important;
}
</style>

{% endblock %}

{% block content %}
<!-- View Selector -->
<div class="view-selector">
    <span class="view-label">View:</span>
    <button class="view-btn" onclick="changeView(4)">1 Month</button>
    <button class="view-btn active" onclick="changeView(12)">3 Months</button>
    <button class="view-btn" onclick="changeView(24)">6 Months</button>
</div>

<div class="metrics-grid" id="metrics-container">
    <!-- Metrics will be dynamically generated here -->
</div>
{% endblock %}

{% block footer %}
<p>Director Observatory • Executive Trends</p>
<p>Last updated: {{ timestamp }}</p>
<p style="opacity: 0.7; font-size: 0.85rem;">Data from Observatory history files</p>
{% endblock %}

{% block extra_js %}
<script>
    const trendsData = {{ metrics_json|safe }};
    let currentView = 12; // Default to 12 weeks

    function changeView(weeks) {
        currentView = weeks;

        // Update button states
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Re-render metrics with new view
        renderMetrics();
    }

    function generateSparkline(data, containerId, unit) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.warn('Container not found:', containerId);
            return;
        }

        // Slice data based on current view
        const viewData = data.slice(-currentView);

        // Validate data
        if (!viewData || viewData.length === 0) {
            console.warn('No data for sparkline:', containerId);
            return;
        }

        const width = container.offsetWidth;
        const height = 60;

        // Check if container has width
        if (width === 0) {
            console.warn('Container has no width:', containerId);
            return;
        }

        const max = Math.max(...viewData);
        const min = Math.min(...viewData);
        const range = max - min || 1;

        // Validate calculated values
        if (!isFinite(max) || !isFinite(min) || !isFinite(range)) {
            console.error('Invalid data values for sparkline:', containerId, { max, min, range, viewData });
            return;
        }

        // Create tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'sparkline-tooltip';
        container.appendChild(tooltip);

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        svg.setAttribute('class', 'sparkline');

        const points = viewData.map((value, index) => {
            const x = viewData.length > 1 ? (index / (viewData.length - 1)) * width : width / 2;
            const y = height - ((value - min) / range) * (height - 10) - 5;
            return `${x},${y}`;
        }).join(' ');

        // Gradient background
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', `gradient-${containerId}`);
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '0%');
        gradient.setAttribute('y2', '100%');

        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('style', 'stop-color:rgba(102,126,234,0.3);stop-opacity:1');

        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('style', 'stop-color:rgba(102,126,234,0);stop-opacity:1');

        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);

        // Area
        const area = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        area.setAttribute('points', `0,${height} ${points} ${width},${height}`);
        area.setAttribute('fill', `url(#gradient-${containerId})`);
        svg.appendChild(area);

        // Line
        const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
        polyline.setAttribute('points', points);
        polyline.setAttribute('fill', 'none');
        polyline.setAttribute('stroke', '#667eea');
        polyline.setAttribute('stroke-width', '2');
        svg.appendChild(polyline);

        // Dots with hover tooltips
        viewData.forEach((value, index) => {
            const x = (index / (viewData.length - 1)) * width;
            const y = height - ((value - min) / range) * (height - 10) - 5;

            // Create invisible larger hit area for easier targeting
            const hitArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            hitArea.setAttribute('cx', x);
            hitArea.setAttribute('cy', y);
            hitArea.setAttribute('r', '12');
            hitArea.setAttribute('fill', 'transparent');
            hitArea.style.cursor = 'pointer';

            // Create visible circle
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '4');
            circle.setAttribute('fill', '#667eea');
            circle.style.transition = 'r 0.2s ease';
            circle.style.pointerEvents = 'none'; // Let hit area handle events

            // Hover effects on hit area
            hitArea.addEventListener('mouseenter', (e) => {
                circle.setAttribute('r', '6');
                tooltip.textContent = `${value} ${unit}`;
                tooltip.classList.add('visible');

                // Position tooltip
                const containerRect = container.getBoundingClientRect();
                const circleRect = circle.getBoundingClientRect();
                tooltip.style.left = (circleRect.left - containerRect.left + circleRect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = (circleRect.top - containerRect.top - tooltip.offsetHeight - 8) + 'px';
            });

            hitArea.addEventListener('mouseleave', () => {
                circle.setAttribute('r', '4');
                tooltip.classList.remove('visible');
            });

            svg.appendChild(hitArea);
            svg.appendChild(circle);
        });

        container.appendChild(svg);
    }

    function renderMetrics() {
        const container = document.getElementById('metrics-container');
        container.innerHTML = '';

        trendsData.forEach(metric => {
            const containerId = `sparkline-${metric.id}`;

            // Create clickable link wrapper
            const link = document.createElement('a');
            link.href = metric.dashboardUrl;
            link.className = 'metric-card-link';

            const card = document.createElement('div');
            card.className = 'metric-card';
            card.innerHTML = `
                <div class="metric-header">
                    <div class="metric-title">
                        <span class="metric-icon">${metric.icon}</span>
                        ${metric.title}
                    </div>
                    <div class="trend-indicator ${metric.cssClass}">
                        ${metric.arrow}
                    </div>
                </div>
                <div class="metric-description">${metric.description}</div>
                <div class="metric-value" style="color: ${metric.ragColor};">${metric.current} <span style="font-size: 1rem; font-weight: normal; color: var(--text-secondary);">${metric.unit}</span></div>
                <div class="metric-change">
                    ${metric.change > 0 ? '+' : ''}${metric.change} ${metric.changeLabel}
                </div>
                <div class="sparkline-container" id="${containerId}"></div>
            `;

            link.appendChild(card);
            container.appendChild(link);

            // Generate sparkline after DOM is updated
            setTimeout(() => generateSparkline(metric.data, containerId, metric.unit), 0);
        });
    }

    // Initialize
    renderMetrics();
</script>
{% endblock %}
