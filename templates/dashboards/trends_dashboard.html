{% extends "dashboards/base_dashboard.html" %}

{% block title %}Executive Trends{% endblock %}

{% block header_title %}Executive Trends Dashboard{% endblock %}
{% block header_subtitle %}Engineering Health Metrics{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ═══════════════════════════════════════════════════════════════
   MODERN MINIMALIST - Frontend-Design Skill
   Design Direction: Clean, Refined, Professional
   Inspiration: Stripe, Linear, Modern SaaS dashboards
   ═══════════════════════════════════════════════════════════════ */

:root {
    --color-slate-50: #f8fafc;
    --color-slate-100: #f1f5f9;
    --color-slate-200: #e2e8f0;
    --color-slate-300: #cbd5e1;
    --color-slate-400: #94a3b8;
    --color-slate-500: #64748b;
    --color-slate-600: #475569;
    --color-slate-700: #334155;
    --color-slate-800: #1e293b;
    --color-slate-900: #0f172a;

    --color-blue-400: #60a5fa;
    --color-blue-500: #3b82f6;
    --color-blue-600: #2563eb;

    --color-emerald-500: #10b981;
    --color-amber-500: #f59e0b;
    --color-red-500: #ef4444;

    --header-gradient-start: var(--color-slate-900) !important;
    --header-gradient-end: var(--color-slate-900) !important;
}

/* Refined typography - Inter with OpenType features */
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    background: var(--color-slate-900) !important;
    color: #ffffff !important;
    font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Sophisticated header */
body .header,
.container .header,
div.header {
    background: var(--color-slate-900) !important;
    border: none !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 64px 32px !important;
}

.header h1 {
    font-weight: 600 !important;
    letter-spacing: -0.02em !important;
    color: #ffffff !important;
    text-transform: none !important;
    font-size: 2.5rem !important;
}

.header p {
    color: var(--color-slate-400) !important;
    font-weight: 400 !important;
    text-transform: none !important;
    letter-spacing: 0 !important;
}

/* Refined View Selector */
.view-selector {
    display: flex;
    gap: 12px;
    margin-bottom: 32px;
    align-items: center;
}

.view-label {
    font-weight: 500;
    color: var(--color-slate-400);
    font-size: 0.875rem;
    letter-spacing: 0.01em;
}

.view-btn {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 6px;
    padding: 8px 20px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-slate-400);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.view-btn:hover {
    border-color: rgba(59, 130, 246, 0.3);
    background: rgba(59, 130, 246, 0.08);
    color: var(--color-blue-400);
}

.view-btn.active {
    background: rgba(59, 130, 246, 0.15);
    border-color: rgba(59, 130, 246, 0.3);
    color: var(--color-blue-400);
}

/* Refined Metrics Grid */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
    margin-bottom: 40px;
}

@media (max-width: 1400px) {
    .metrics-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 1024px) {
    .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 640px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }
}

/* Premium Metric Cards */
.metric-card-link {
    display: block;
    text-decoration: none;
    color: inherit;
    height: 100%;
}

.metric-card {
    background: var(--color-slate-900);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    height: 100%;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
    opacity: 0;
    transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
    border-color: rgba(59, 130, 246, 0.3);
}

.metric-card:hover::before {
    opacity: 1;
}

.metric-card:active {
    transform: translateY(-1px);
}

/* Card Header */
.metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.metric-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 8px;
    letter-spacing: -0.01em;
}

.metric-icon {
    font-size: 1.25rem;
    filter: grayscale(0.2);
}

.metric-card:hover .metric-icon {
    filter: grayscale(0);
}

/* Trend Indicators */
.trend-indicator {
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.trend-up { color: var(--color-red-500); }
.trend-down { color: var(--color-emerald-500); }
.trend-stable { color: var(--color-amber-500); }

/* Card Content */
.metric-description {
    font-size: 0.8125rem;
    color: var(--color-slate-400);
    margin-bottom: 16px;
    line-height: 1.5;
}

.metric-value {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 6px;
    letter-spacing: -0.02em;
}

.metric-change {
    font-size: 0.8125rem;
    color: var(--color-slate-500);
    margin-bottom: 16px;
    font-weight: 500;
}

/* Sparkline Styling */
.sparkline-container {
    height: 60px;
    margin-top: 16px;
    position: relative;
}

.sparkline {
    width: 100%;
    height: 100%;
}

.sparkline-tooltip {
    position: absolute;
    background: var(--color-slate-800);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #ffffff;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    white-space: nowrap;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.sparkline-tooltip.visible {
    opacity: 1;
}

/* ═══════════════════════════════════════════════════════════════
   LIGHT THEME SUPPORT - Complete styling for light mode
   ═══════════════════════════════════════════════════════════════ */

[data-theme="light"] body {
    background: #ffffff !important;
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header {
    background: #ffffff !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] .header h1 {
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header p {
    color: var(--color-slate-600) !important;
}

/* View Selector - Light Mode */
[data-theme="light"] .view-label {
    color: var(--color-slate-600);
}

[data-theme="light"] .view-btn {
    background: var(--color-slate-100);
    border-color: var(--color-slate-200);
    color: var(--color-slate-700);
}

[data-theme="light"] .view-btn:hover {
    border-color: var(--color-blue-500);
    background: rgba(59, 130, 246, 0.1);
    color: var(--color-blue-600);
}

[data-theme="light"] .view-btn.active {
    background: rgba(59, 130, 246, 0.15);
    border-color: var(--color-blue-500);
    color: var(--color-blue-600);
}

/* Metric Cards - Light Mode */
[data-theme="light"] .metric-card {
    background: #ffffff;
    border-color: var(--color-slate-200);
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
}

[data-theme="light"] .metric-card:hover {
    border-color: var(--color-blue-400);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
}

[data-theme="light"] .metric-card::before {
    background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.4), transparent);
}

/* Card Content - Light Mode */
[data-theme="light"] .metric-title {
    color: var(--color-slate-900);
}

[data-theme="light"] .metric-description {
    color: var(--color-slate-600);
}

[data-theme="light"] .metric-change {
    color: var(--color-slate-600);
}

/* Sparkline Tooltip - Light Mode */
[data-theme="light"] .sparkline-tooltip {
    background: #ffffff;
    border-color: var(--color-blue-400);
    color: var(--color-slate-900);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Footer - Light Mode */
[data-theme="light"] .footer p {
    color: var(--color-slate-600) !important;
}

/* ── Alerts Banner ─────────────────────────────────────── */
.alerts-banner {
    background: rgba(239, 68, 68, 0.07);
    border: 1px solid rgba(239, 68, 68, 0.25);
    border-radius: 8px;
    margin-bottom: 28px;
    overflow: hidden;
}
.alerts-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    cursor: pointer;
    user-select: none;
}
.alerts-icon {
    margin-right: 8px;
    color: var(--color-amber-500);
}
.alerts-title {
    font-size: 0.9rem;
    color: #fff;
}
.alerts-subtitle {
    color: var(--color-slate-400);
    font-weight: 400;
}
.alerts-toggle {
    background: none;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 4px;
    color: var(--color-slate-400);
    font-size: 0.75rem;
    padding: 4px 10px;
    cursor: pointer;
}
.alerts-list {
    padding: 0 20px 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.alerts-toolbar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0 10px;
    border-bottom: 1px solid rgba(255,255,255,0.07);
    margin-bottom: 8px;
}
.alerts-search {
    flex: 1;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 5px;
    color: var(--color-slate-200);
    font-size: 0.8rem;
    padding: 5px 10px;
    outline: none;
}
.alerts-search::placeholder { color: var(--color-slate-500); }
.alerts-search:focus { border-color: rgba(255,255,255,0.25); }
.alerts-filter-btns { display: flex; gap: 6px; flex-shrink: 0; }
.alerts-filter-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 5px;
    color: var(--color-slate-400);
    cursor: pointer;
    font-size: 0.75rem;
    padding: 4px 10px;
    white-space: nowrap;
}
.alerts-filter-btn.active {
    background: rgba(99,102,241,0.25);
    border-color: rgba(99,102,241,0.5);
    color: #fff;
}
.alert-row {
    display: flex;
    align-items: baseline;
    gap: 10px;
    font-size: 0.85rem;
    padding: 6px 10px;
    border-radius: 4px;
    background: rgba(255,255,255,0.03);
}
.alert-row.hidden { display: none; }
.alert-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 2px 7px;
    border-radius: 3px;
    letter-spacing: 0.04em;
    flex-shrink: 0;
}
.badge-critical { background: rgba(239,68,68,0.25); color: #fca5a5; }
.badge-high     { background: rgba(239,68,68,0.15); color: #fca5a5; }
.badge-warn     { background: rgba(245,158,11,0.2);  color: #fcd34d; }
.badge-medium   { background: rgba(245,158,11,0.15); color: #fcd34d; }
.alert-dash {
    color: var(--color-blue-400);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    flex-shrink: 0;
}
.alert-msg { color: var(--color-slate-300); flex: 1; }
.alerts-no-results {
    color: var(--color-slate-500);
    font-size: 0.82rem;
    padding: 6px 10px;
    display: none;
}
</style>
{% endblock %}

{% block content %}
{% if active_alerts %}
<!-- Active Alerts Banner -->
<div class="alerts-banner" id="alerts-banner">
    <div class="alerts-header" onclick="toggleAlerts()">
        <div class="alerts-title">
            <span class="alerts-icon">&#9888;</span>
            <strong>{{ active_alerts|length }} Active Alert{{ 's' if active_alerts|length != 1 else '' }}</strong>
            <span class="alerts-subtitle">— anomalies and threshold violations detected this week</span>
        </div>
        <button class="alerts-toggle" id="alerts-toggle-btn">Show</button>
    </div>
    <div class="alerts-list" id="alerts-list" style="display: none">
        <div class="alerts-toolbar">
            <input class="alerts-search" id="alerts-search" type="text" placeholder="Search alerts..." oninput="applyAlertFilters()">
            <div class="alerts-filter-btns" id="alerts-filter-btns"></div>
        </div>
        {% for alert in active_alerts %}
        <div class="alert-row alert-{{ alert.severity }}" data-severity="{{ alert.severity }}" data-text="{{ alert.message|lower }} {{ alert.dashboard|lower }}">
            <span class="alert-badge badge-{{ alert.severity }}">{{ alert.severity|upper }}</span>
            <span class="alert-dash">{{ alert.dashboard }}</span>
            <span class="alert-msg">{{ alert.message }}</span>
        </div>
        {% endfor %}
        <div class="alerts-no-results" id="alerts-no-results">No alerts match your search.</div>
    </div>
</div>
{% endif %}

<!-- View Selector -->
<div class="view-selector">
    <span class="view-label">View:</span>
    <button class="view-btn" onclick="changeView(4)">1 Month</button>
    <button class="view-btn active" onclick="changeView(12)">3 Months</button>
    <button class="view-btn" onclick="changeView(24)">6 Months</button>
</div>

<div class="metrics-grid" id="metrics-container">
    <!-- Metrics will be dynamically generated here -->
</div>
{% endblock %}

{% block footer %}
<p>Director Observatory • Executive Trends</p>
<p>Last updated: {{ timestamp }}</p>
<p style="opacity: 0.7; font-size: 0.85rem;">Data from Observatory history files</p>
{% endblock %}

{% block extra_js %}
<script>
    const trendsData = {{ metrics_json|safe }};
    let currentView = 12; // Default to 12 weeks

    function changeView(weeks) {
        currentView = weeks;

        // Update button states
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Re-render metrics with new view
        renderMetrics();
    }

    function generateSparkline(data, containerId, unit) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.warn('Container not found:', containerId);
            return;
        }

        // Slice data based on current view
        const viewData = data.slice(-currentView);

        // Validate data
        if (!viewData || viewData.length === 0) {
            console.warn('No data for sparkline:', containerId);
            return;
        }

        const width = container.offsetWidth;
        const height = 60;

        // Check if container has width
        if (width === 0) {
            console.warn('Container has no width:', containerId);
            return;
        }

        const max = Math.max(...viewData);
        const min = Math.min(...viewData);
        const range = max - min || 1;

        // Validate calculated values
        if (!isFinite(max) || !isFinite(min) || !isFinite(range)) {
            console.error('Invalid data values for sparkline:', containerId, { max, min, range, viewData });
            return;
        }

        // Create tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'sparkline-tooltip';
        container.appendChild(tooltip);

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        svg.setAttribute('class', 'sparkline');

        const points = viewData.map((value, index) => {
            const x = viewData.length > 1 ? (index / (viewData.length - 1)) * width : width / 2;
            const y = height - ((value - min) / range) * (height - 10) - 5;
            return `${x},${y}`;
        }).join(' ');

        // Minimalist gradient - refined blue tones
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', `gradient-${containerId}`);
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '0%');
        gradient.setAttribute('y2', '100%');

        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('style', 'stop-color:rgba(59,130,246,0.2);stop-opacity:1');

        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('style', 'stop-color:rgba(59,130,246,0);stop-opacity:1');

        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);

        // Area
        const area = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        area.setAttribute('points', `0,${height} ${points} ${width},${height}`);
        area.setAttribute('fill', `url(#gradient-${containerId})`);
        svg.appendChild(area);

        // Line - refined blue
        const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
        polyline.setAttribute('points', points);
        polyline.setAttribute('fill', 'none');
        polyline.setAttribute('stroke', '#3b82f6');
        polyline.setAttribute('stroke-width', '2');
        svg.appendChild(polyline);

        // Dots with hover tooltips
        viewData.forEach((value, index) => {
            const x = (index / (viewData.length - 1)) * width;
            const y = height - ((value - min) / range) * (height - 10) - 5;

            // Create invisible larger hit area for easier targeting
            const hitArea = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            hitArea.setAttribute('cx', x);
            hitArea.setAttribute('cy', y);
            hitArea.setAttribute('r', '12');
            hitArea.setAttribute('fill', 'transparent');
            hitArea.style.cursor = 'pointer';

            // Create visible circle - refined blue
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '4');
            circle.setAttribute('fill', '#3b82f6');
            circle.style.transition = 'r 0.2s ease';
            circle.style.pointerEvents = 'none'; // Let hit area handle events

            // Hover effects on hit area
            hitArea.addEventListener('mouseenter', (e) => {
                circle.setAttribute('r', '6');
                tooltip.textContent = `${value} ${unit}`;
                tooltip.classList.add('visible');

                // Position tooltip
                const containerRect = container.getBoundingClientRect();
                const circleRect = circle.getBoundingClientRect();
                tooltip.style.left = (circleRect.left - containerRect.left + circleRect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = (circleRect.top - containerRect.top - tooltip.offsetHeight - 8) + 'px';
            });

            hitArea.addEventListener('mouseleave', () => {
                circle.setAttribute('r', '4');
                tooltip.classList.remove('visible');
            });

            svg.appendChild(hitArea);
            svg.appendChild(circle);
        });

        container.appendChild(svg);
    }

    function renderMetrics() {
        const container = document.getElementById('metrics-container');
        container.innerHTML = '';

        trendsData.forEach(metric => {
            const containerId = `sparkline-${metric.id}`;

            // Create clickable link wrapper
            const link = document.createElement('a');
            link.href = metric.dashboardUrl;
            link.className = 'metric-card-link';

            const card = document.createElement('div');
            card.className = 'metric-card';
            card.innerHTML = `
                <div class="metric-header">
                    <div class="metric-title">
                        <span class="metric-icon">${metric.icon}</span>
                        ${metric.title}
                    </div>
                    <div class="trend-indicator ${metric.cssClass}">
                        ${metric.arrow}
                    </div>
                </div>
                <div class="metric-description">${metric.description}</div>
                <div class="metric-value" style="color: ${metric.ragColor};">${metric.current} <span style="font-size: 1rem; font-weight: normal; color: var(--text-secondary);">${metric.unit}</span></div>
                <div class="metric-change">
                    ${metric.change > 0 ? '+' : ''}${metric.change} ${metric.changeLabel}
                </div>
                <div class="sparkline-container" id="${containerId}"></div>
            `;

            link.appendChild(card);
            container.appendChild(link);

            // Generate sparkline after DOM is updated
            setTimeout(() => generateSparkline(metric.data, containerId, metric.unit), 0);
        });
    }

    // Initialize
    renderMetrics();

    // Alerts banner toggle
    function toggleAlerts() {
        const list = document.getElementById('alerts-list');
        const btn  = document.getElementById('alerts-toggle-btn');
        if (!list) return;
        if (list.style.display === 'none') {
            list.style.display = 'flex';
            if (btn) btn.textContent = 'Hide';
            buildAlertFilterButtons();
        } else {
            list.style.display = 'none';
            if (btn) btn.textContent = 'Show';
        }
    }
    window.toggleAlerts = toggleAlerts;

    // Alerts search + severity filter
    let activeAlertFilter = 'all';

    function buildAlertFilterButtons() {
        const container = document.getElementById('alerts-filter-btns');
        if (!container || container.childElementCount > 0) return; // already built
        const rows = document.querySelectorAll('.alert-row[data-severity]');
        const counts = {};
        rows.forEach(r => { const s = r.dataset.severity; counts[s] = (counts[s] || 0) + 1; });
        // Build All button first, then one button per distinct severity actually present
        const severities = Object.keys(counts);
        [{ sev: 'all', label: `All (${rows.length})` },
         ...severities.map(s => ({ sev: s, label: `${s.charAt(0).toUpperCase() + s.slice(1)} (${counts[s]})` }))
        ].forEach(({ sev, label }) => {
            const btn = document.createElement('button');
            btn.className = 'alerts-filter-btn' + (sev === 'all' ? ' active' : '');
            btn.textContent = label;
            btn.dataset.filter = sev;
            btn.onclick = () => setAlertFilter(sev);
            container.appendChild(btn);
        });
    }

    function setAlertFilter(sev) {
        activeAlertFilter = sev;
        document.querySelectorAll('.alerts-filter-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.filter === sev);
        });
        applyAlertFilters();
    }

    function applyAlertFilters() {
        const query = (document.getElementById('alerts-search')?.value || '').toLowerCase();
        const rows = document.querySelectorAll('.alert-row[data-severity]');
        let visible = 0;
        rows.forEach(row => {
            const sevMatch = activeAlertFilter === 'all' || row.dataset.severity === activeAlertFilter;
            const textMatch = !query || row.dataset.text.includes(query);
            const show = sevMatch && textMatch;
            row.classList.toggle('hidden', !show);
            if (show) visible++;
        });
        const noResults = document.getElementById('alerts-no-results');
        if (noResults) noResults.style.display = visible === 0 ? 'block' : 'none';
    }
    window.applyAlertFilters = applyAlertFilters;
</script>
{% endblock %}
