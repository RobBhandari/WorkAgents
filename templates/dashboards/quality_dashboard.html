{% extends "dashboards/base_dashboard.html" %}

{% block title %}Quality Dashboard{% endblock %}
{% block meta_description %}Bug quality metrics and fix effectiveness - Director Observatory{% endblock %}

{% block header_title %}Quality Dashboard{% endblock %}
{% block header_subtitle %}Bug Quality & Fix Effectiveness{% endblock %}
{% block header_metadata %}Week {{ week_number }} â€¢ {{ week_date }} â€¢ Generated {{ generation_date }}{% endblock %}
{% block footer_context %}Quality Dashboard{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODERN MINIMALIST - Refined Dashboard Styling
   Design Direction: Clean, Refined, Professional
   Inspiration: Stripe, Linear, Modern SaaS dashboards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
    --color-slate-50: #f8fafc;
    --color-slate-100: #f1f5f9;
    --color-slate-200: #e2e8f0;
    --color-slate-300: #cbd5e1;
    --color-slate-400: #94a3b8;
    --color-slate-500: #64748b;
    --color-slate-600: #475569;
    --color-slate-700: #334155;
    --color-slate-800: #1e293b;
    --color-slate-900: #0f172a;

    --color-blue-400: #60a5fa;
    --color-blue-500: #3b82f6;
    --color-blue-600: #2563eb;

    --color-emerald-500: #10b981;
    --color-amber-500: #f59e0b;
    --color-red-500: #ef4444;

    --header-gradient-start: var(--color-slate-900) !important;
    --header-gradient-end: var(--color-slate-900) !important;
}

/* Refined typography - Inter with OpenType features */
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    background: var(--color-slate-900) !important;
    color: #ffffff !important;
    font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Sophisticated header */
body .header,
.container .header,
div.header {
    background: var(--color-slate-900) !important;
    border: none !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 64px 32px !important;
}

.header h1 {
    font-weight: 600 !important;
    letter-spacing: -0.02em !important;
    color: #ffffff !important;
    text-transform: none !important;
    font-size: 2.5rem !important;
}

.header p,
.header .subtitle {
    color: var(--color-slate-400) !important;
    font-weight: 400 !important;
    text-transform: none !important;
    letter-spacing: 0 !important;
}

/* Summary Cards - Refined with subtle borders */
.summary-card,
.card {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 24px !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.summary-card:hover,
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3) !important;
    border-color: rgba(59, 130, 246, 0.3) !important;
}

/* Tables - Refined styling */
table {
    border-collapse: collapse !important;
}

th {
    background: var(--color-slate-800) !important;
    color: var(--color-slate-400) !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    padding: 14px 16px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
}

tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.06) !important;
    transition: background-color 0.2s ease !important;
}

tbody tr:hover {
    background: rgba(255, 255, 255, 0.02) !important;
}

td {
    padding: 12px 16px !important;
    color: #ffffff !important;
}

/* Preserve chevron spacing for expandable rows */
tbody tr.data-row td:first-child {
    padding-left: 30px !important;
}

tbody tr.data-row td:first-child::before {
    content: 'â–¶';
    position: absolute;
    left: 12px;
    font-size: 0.7rem;
    color: var(--color-slate-400);
    transition: transform 0.3s ease;
}

tbody tr.data-row.expanded td:first-child::before {
    transform: rotate(90deg);
}

/* Status badges - Refined colors */
.status-good { color: var(--color-emerald-500) !important; }
.status-caution { color: var(--color-amber-500) !important; }
.status-action { color: var(--color-red-500) !important; }
.status-inactive { color: var(--color-slate-500) !important; }

/* Detail rows - Refined styling */
.detail-row {
    display: none;
}

.detail-row.show {
    display: table-row;
}

.detail-content {
    background: var(--color-slate-800) !important;
    padding: 24px !important;
    border-left: 2px solid rgba(59, 130, 246, 0.3) !important;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h3,
.detail-section h4 {
    color: #ffffff !important;
    margin-bottom: 12px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.detail-metric {
    background: var(--color-slate-900) !important;
    border: 1px solid rgba(255, 255, 255, 0.06) !important;
    border-radius: 8px !important;
    padding: 16px !important;
    color: var(--color-slate-300) !important;
}

.detail-metric-label {
    font-size: 0.75rem !important;
    text-transform: uppercase !important;
    color: var(--color-slate-400) !important;
    margin-bottom: 8px !important;
    letter-spacing: 0.05em !important;
}

.detail-metric-value {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    color: #ffffff !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIGHT THEME SUPPORT - Complete styling for light mode
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

[data-theme="light"] body {
    background: #ffffff !important;
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header {
    background: #ffffff !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] .header h1 {
    color: var(--color-slate-900) !important;
}

[data-theme="light"] .header p,
[data-theme="light"] .header .subtitle {
    color: var(--color-slate-600) !important;
}

[data-theme="light"] .summary-card,
[data-theme="light"] .card {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03) !important;
}

[data-theme="light"] .summary-card:hover,
[data-theme="light"] .card:hover {
    border-color: var(--color-blue-400) !important;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05) !important;
}

[data-theme="light"] th {
    background: var(--color-slate-100) !important;
    color: var(--color-slate-700) !important;
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr {
    border-bottom-color: var(--color-slate-200) !important;
}

[data-theme="light"] tbody tr:hover {
    background: var(--color-slate-50) !important;
}

[data-theme="light"] td {
    color: var(--color-slate-900) !important;
}

/* Detail rows - Light Mode */
[data-theme="light"] .detail-content {
    background: var(--color-slate-100) !important;
}

[data-theme="light"] .detail-metric {
    background: #ffffff !important;
    border-color: var(--color-slate-200) !important;
}

[data-theme="light"] .detail-metric-value {
    color: var(--color-slate-900) !important;
}

/* Chevron - Light Mode */
[data-theme="light"] tbody tr.data-row td:first-child::before {
    color: var(--color-slate-600) !important;
}

/* Footer - Light Mode */
[data-theme="light"] .footer p {
    color: var(--color-slate-600) !important;
}
</style>

{% endblock %}

{% block content %}
<!-- Executive Summary -->
<div class="executive-summary">
    <div class="status-badge" style="background: {{ status_color }};">{{ status_text }}</div>
    <h2 style="margin-bottom: 10px;">Executive Summary</h2>
    <p style="color: var(--text-secondary); margin-bottom: 20px;">
        Quality metrics across {{ project_count }} projects. These metrics show how effectively we fix bugs and prevent quality issues.
    </p>

    <div class="summary-grid">
        {% for card in summary_cards %}
        {{ card|safe }}
        {% endfor %}
    </div>
</div>

<!-- Project Comparison Table -->
<div class="card">
    <h2>Project Quality Metrics</h2>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Project</th>
                    <th>MTTR</th>
                    <th>Median Bug Age</th>
                    <th>Open Bugs</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
            {% for project in projects %}
                <tr class="data-row" onclick="toggleDetail('detail-{{ loop.index }}', this)">
                    <td>{{ project.name }}</td>
                    <td>{{ project.mttr_str }}</td>
                    <td>{{ project.median_age_str }}</td>
                    <td>{{ project.open_bugs }}</td>
                    <td title="{{ project.status_tooltip }}">{{ project.status|safe }}</td>
                </tr>
                <tr id="detail-{{ loop.index }}" class="detail-row">
                    <td colspan="5">
                        {{ project.details_html|safe }}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Glossary -->
<div class="glossary">
    <div class="glossary-header" onclick="toggleGlossary()">
        <h3>ğŸ“– What These Metrics Mean</h3>
        <span class="glossary-toggle" id="glossary-toggle">â–¼</span>
    </div>
    <div class="glossary-content" id="glossary-content">
        <div class="glossary-item">
            <div class="glossary-term">MTTR (Mean Time To Repair)</div>
            <div class="glossary-definition">
                Average time (in days) from when a bug is created to when it's closed.
                This measures how quickly your team resolves bugs. Lower MTTR means faster bug resolution.
                Calculated as: (Bug Closed Date - Bug Created Date) averaged across all closed bugs.
                <br><strong>Target:</strong> Keep below 7 days for most bugs
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Bug Age (Median)</div>
            <div class="glossary-definition">
                The middle value of how long bugs stay open before being fixed.
                Calculated from actual System.CreatedDate â†’ Now for all open bugs.
                Older bugs suggest capacity constraints or prioritization issues.
                <br><strong>Target:</strong> Depends on severity - critical bugs should be fixed quickly
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Percentile Metrics (P85, P95)</div>
            <div class="glossary-definition">
                While median shows the middle value, percentiles reveal how your worst-performing bugs are doing.
                <strong>P85</strong> means 85% of bugs are at or below this value, while <strong>P95</strong> means 95% are at or below.
                These metrics help identify tail-end problems that median alone might hide.
                <br><br>
                <strong>Bug Age P85:</strong> Shows how long your slowest 15% of bugs have been sitting open.
                <ul>
                    <li><strong style="color: #10b981;">âœ“ &lt; 60 days:</strong> Most bugs are being addressed in a reasonable timeframe</li>
                    <li><strong style="color: #f59e0b;">âš  60-180 days:</strong> A significant portion of bugs are aging - review prioritization and capacity</li>
                    <li><strong style="color: #ef4444;">â— &gt; 180 days:</strong> Many bugs are stale (6+ months) - likely indicates backlog neglect or insufficient capacity</li>
                </ul>
                <br>
                <strong>Bug Age P95:</strong> Reveals your absolute worst-case bug aging - the oldest 5% that need attention.
                <ul>
                    <li><strong style="color: #10b981;">âœ“ &lt; 90 days:</strong> Even your oldest bugs are relatively fresh</li>
                    <li><strong style="color: #f59e0b;">âš  90-365 days:</strong> Your oldest bugs are approaching or exceeding 1 year - consider triage or closure</li>
                    <li><strong style="color: #ef4444;">â— &gt; 365 days:</strong> Significant technical debt accumulation - oldest bugs are ancient and may no longer be relevant</li>
                </ul>
                <br>
                <strong>MTTR P85:</strong> Shows how long it takes to fix your slower-to-resolve bugs (not just the easy ones).
                <ul>
                    <li><strong style="color: #10b981;">âœ“ &lt; 14 days:</strong> Most bugs are fixed within 2 weeks - healthy fix velocity</li>
                    <li><strong style="color: #f59e0b;">âš  14-30 days:</strong> Slower bugs take 2-4 weeks to fix - may indicate complexity or resource constraints</li>
                    <li><strong style="color: #ef4444;">â— &gt; 30 days:</strong> Many bugs take over a month to fix - investigate root causes (complexity, prioritization, capacity)</li>
                </ul>
                <br>
                <strong>MTTR P95:</strong> Captures your most difficult or delayed bug fixes.
                <ul>
                    <li><strong style="color: #10b981;">âœ“ &lt; 21 days:</strong> Even complex bugs get resolved within 3 weeks</li>
                    <li><strong style="color: #f59e0b;">âš  21-45 days:</strong> Hardest bugs take 3-6 weeks - monitor for patterns (specific areas, types, teams)</li>
                    <li><strong style="color: #ef4444;">â— &gt; 45 days:</strong> Worst-case fixes take over 6 weeks - likely indicates systematic issues with complex bugs</li>
                </ul>
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Distribution Bucket Colors</div>
            <div class="glossary-definition">
                Both Bug Age and MTTR distribution buckets are color-coded to show which time ranges represent healthy vs. problematic performance.
                The border color indicates the inherent quality of having bugs in that time bucket.
                <br><br>
                <strong>Bug Age Distribution:</strong>
                <ul>
                    <li><strong style="color: #10b981;">Green (0-30 days):</strong> Fresh bugs that are being actively worked - this is healthy</li>
                    <li><strong style="color: #f59e0b;">Amber (31-90 days):</strong> Bugs aging into medium-term backlog - watch for accumulation</li>
                    <li><strong style="color: #ef4444;">Red (90+ days):</strong> Stale bugs accumulating technical debt - these need attention</li>
                </ul>
                <strong>What to look for:</strong> You want most bugs in the green buckets. High counts in red buckets (90+ days) indicate backlog accumulation and potential technical debt.
                <br><br>
                <strong>MTTR Distribution:</strong>
                <ul>
                    <li><strong style="color: #10b981;">Green (0-7 days):</strong> Fast bug fixes - excellent resolution speed</li>
                    <li><strong style="color: #f59e0b;">Amber (7-30 days):</strong> Moderate fix time - acceptable but watch for trends</li>
                    <li><strong style="color: #ef4444;">Red (30+ days):</strong> Slow fixes - investigate causes (complexity, capacity, prioritization)</li>
                </ul>
                <strong>What to look for:</strong> Healthy projects have most bugs in green buckets (quick fixes). High counts in red buckets suggest systematic delays in bug resolution.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Overall Status</div>
            <div class="glossary-definition">
                The status indicator for each project is calculated by evaluating quality metrics together.
                <br><br>
                <strong>Status Determination:</strong>
                <ul>
                    <li><strong style="color: #10b981;">âœ“ Good:</strong> All metrics meet target thresholds</li>
                    <li><strong style="color: #f59e0b;">âš  Caution:</strong> One metric needs attention</li>
                    <li><strong style="color: #ef4444;">â— Action Needed:</strong> Multiple metrics miss targets</li>
                </ul>
                <br>
                <strong>Thresholds Used:</strong>
                <ul>
                    <li><strong>MTTR:</strong> Good &lt; 7 days | Caution 7-14 days | Poor &gt; 14 days</li>
                    <li><strong>Median Bug Age:</strong> Good &lt; 30 days | Caution 30-60 days | Poor &gt; 60 days</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
