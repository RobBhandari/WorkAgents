{% extends "dashboards/base_dashboard.html" %}

{% block title %}Collaboration Dashboard{% endblock %}
{% block meta_description %}Code review and PR metrics - Team collaboration{% endblock %}

{% block header_title %}Collaboration Dashboard{% endblock %}
{% block header_subtitle %}Code Review & PR Metrics - Team Collaboration{% endblock %}
{% block footer_context %}Collaboration Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard-specific styles */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px var(--shadow);
        border-left: 4px solid #fb7185;
    }

    .metric-label {
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
    }

    .metric-value {
        color: var(--text-primary);
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .metric-detail {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .table-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px var(--shadow);
        margin-bottom: 20px;
    }

    h2 {
        color: var(--text-primary);
        font-size: 1.3rem;
        margin-bottom: 16px;
    }

    /* Status badge colors */
    .status-good {
        color: #10b981;
    }

    .status-caution {
        color: #f59e0b;
    }

    .status-action {
        color: #ef4444;
    }

    .status-no-data {
        color: #94a3b8;
    }
</style>
{% endblock %}

{% block content %}
<!-- Summary cards -->
<div class="metrics-grid">
    {% for card in summary_cards %}
    {{ card|safe }}
    {% endfor %}
</div>

<!-- Projects table -->
<div class="table-card">
    <h2>PR Metrics by Project</h2>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Project</th>
                    <th>Total PRs</th>
                    <th>Merge Time (Median)</th>
                    <th>Iterations (Median)</th>
                    <th>Size (Median Commits)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                <tr>
                    <td><strong>{{ project.name }}</strong></td>
                    <td>{{ project.total_prs }}</td>
                    <td title="{{ project.merge_detail }}">{{ project.merge_display }}</td>
                    <td title="{{ project.iterations_detail }}">{{ project.iterations_display }}</td>
                    <td title="{{ project.size_detail }}">{{ project.size_display }}</td>
                    <td title="{{ project.status_tooltip }}">
                        <span class="status-{{ project.status_class }}">{{ project.status_text }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Glossary -->
<div class="glossary">
    <div class="glossary-header" onclick="toggleGlossary()">
        <h3>üìñ What These Metrics Mean</h3>
        <span class="glossary-toggle" id="glossary-toggle">‚ñº</span>
    </div>
    <div class="glossary-content" id="glossary-content">
        <div class="glossary-item">
            <div class="glossary-term">Code Review Metrics</div>
            <div class="glossary-definition">
                Code review metrics measure the efficiency and effectiveness of your team's collaboration process.
                Fast, thorough reviews help maintain code quality while keeping development velocity high.
                These metrics help identify bottlenecks in the review process and opportunities for improvement.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">PR Merge Time (Median)</div>
            <div class="glossary-definition">
                The total time from when a pull request is created to when it's merged into the main branch, measured in hours.
                <strong>Lower is better</strong> - faster merges mean quicker delivery and less time for merge conflicts to develop.
                <br><br>
                This metric includes review time, iteration time, and any approval/CI delays.
                Long merge times can indicate complex changes, multiple review rounds, or process bottlenecks.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Review Iteration Count (Median)</div>
            <div class="glossary-definition">
                The number of review cycles (comments, changes, re-review) before a PR is merged.
                <strong>Fewer iterations can indicate</strong> clear requirements, good PR descriptions, and aligned expectations.
                <br><br>
                However, some iteration is healthy - it means thorough review.
                Very high iteration counts might suggest unclear requirements, large PR scope,
                or misaligned expectations between author and reviewers.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">PR Size (Median Commits)</div>
            <div class="glossary-definition">
                The number of commits in a pull request. Used as a proxy for PR complexity and reviewability.
                <strong>Smaller PRs are generally easier to review</strong> and have faster review cycles.
                <br><br>
                Small PRs (1-5 commits) are easier to review thoroughly and merge quickly.
                Large PRs (>10 commits) may indicate features that could be broken down,
                or complex refactorings that need extra review attention.
                <br><br>
                Note: Commit count is an imperfect proxy - what matters most is the amount of code change and conceptual complexity.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Overall Status</div>
            <div class="glossary-definition">
                The status indicator for each project is calculated by evaluating collaboration metrics together.
                <br><br>
                <strong>Status Determination:</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong style="color: #10b981;">‚úì Good:</strong> All metrics meet target thresholds</li>
                    <li><strong style="color: #f59e0b;">‚ö† Caution:</strong> One metric needs attention</li>
                    <li><strong style="color: #ef4444;">‚óè Action Needed:</strong> Multiple metrics miss targets</li>
                </ul>
                <br>
                <strong>Thresholds Used:</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>Merge Time:</strong> Good &lt; 24h | Caution 24-72h | Poor &gt; 72h</li>
                    <li><strong>Iterations:</strong> Good ‚â§ 2 | Caution 3-5 | Poor &gt; 5</li>
                    <li><strong>PR Size:</strong> Good ‚â§ 5 commits | Caution 6-10 | Poor &gt; 10 commits</li>
                </ul>
                <br>
                <em>Note: These thresholds are guidelines based on common industry practices. Hover over the status to see specific metric values for each project.</em>
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Median vs P85</div>
            <div class="glossary-definition">
                <strong>Median (P50):</strong> The middle value - half of PRs are faster, half are slower.
                This represents the typical experience.
                <br><br>
                <strong>P85 (85th Percentile):</strong> 85% of PRs complete within this time.
                This shows realistic upper bounds while filtering out extreme outliers.
                <br><br>
                Together, these give you both typical and worst-case scenarios for planning.
            </div>
        </div>

        <h3 style="margin-top: 30px; color: #f5576c;">üìä Data Collection Details</h3>

        <div class="glossary-item">
            <div class="glossary-term">Time Period</div>
            <div class="glossary-definition">
                <strong>90-day lookback period</strong> for all PR metrics.
                This provides sufficient data for statistical significance while remaining relevant to current team practices.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">PR Criteria</div>
            <div class="glossary-definition">
                Only completed (merged or abandoned) pull requests are analyzed.
                Draft PRs and PRs still in progress are excluded.
                Review time is measured from PR creation to first substantive review comment.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Sample Size</div>
            <div class="glossary-definition">
                Each metric shows its sample size in the tooltip.
                Larger sample sizes (>30 PRs) provide more statistically reliable metrics.
                Smaller samples may show higher variability and should be interpreted with care.
            </div>
        </div>

        <div class="glossary-item">
            <div class="glossary-term">Why These Metrics Matter</div>
            <div class="glossary-definition">
                Fast, effective code reviews improve both code quality and developer productivity.
                Long review delays frustrate developers, increase context-switching costs,
                and slow down feature delivery. These metrics help teams identify and address
                collaboration bottlenecks while maintaining quality standards.
            </div>
        </div>
    </div>
</div>
{% endblock %}
