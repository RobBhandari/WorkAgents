{% extends "dashboards/base_dashboard.html" %}

{% block title %}Exploitable Vulnerabilities{% endblock %}
{% block meta_description %}Exploitable vulnerabilities with CISA KEV findings - Director Observatory{% endblock %}

{% block header_title %}Exploitable Vulnerabilities{% endblock %}
{% block header_subtitle %}Findings present in the CISA Known Exploited Vulnerabilities (KEV) catalogue{% endblock %}
{% block footer_context %}Exploitable Vulnerabilities Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* No-data state */
    .no-exploitable {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 0.9rem;
        padding: 4px 0;
    }

    /* Table column colours */
    td.col-critical { color: #dc2626; font-weight: 700; }
    td.col-high     { color: #ea580c; font-weight: 700; }
    td.col-medium   { color: #d97706; font-weight: 700; }

    /* Expandable rows â€” arrow handled by framework ::before on .data-row */
    tr.detail-row > td { padding: 0; border-top: none; }

    /* Vulnerability mini-table â€” mirrors security dashboard */
    .vuln-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .vuln-table th { background: var(--bg-secondary); color: var(--text-primary); padding: 8px 12px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border-color); }
    .vuln-table td { padding: 8px 12px; border-bottom: 1px solid var(--border-color); vertical-align: top; color: var(--text-primary); }
    .vuln-table tr:last-child td { border-bottom: none; }
    .vuln-source { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; }
    .vuln-id { font-family: monospace; font-size: 0.85rem; color: var(--text-secondary); }
    /* Severity pill badges â€” same as security dashboard */
    .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; }
    .badge-critical { background: rgba(220, 38, 38, 0.2); color: #dc2626; }
    .badge-high     { background: rgba(234, 88, 12, 0.2); color: #ea580c; }
    .badge-medium   { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
    .truncation-note { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px; font-style: italic; }
    /* Filter bar â€” mirrors security dashboard */
    .bucket-filter-bar { display: flex; align-items: center; gap: 10px; padding: 8px 0 10px; flex-wrap: wrap; }
    .bucket-search-input { flex: 1; min-width: 200px; padding: 7px 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.9rem; outline: none; }
    .bucket-search-input:focus { border-color: #667eea; box-shadow: 0 0 0 2px rgba(102,126,234,0.2); }
    .bucket-filter-buttons { display: flex; gap: 6px; }
    .bucket-filter-buttons button { padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem; cursor: pointer; transition: all 0.15s; }
    .bucket-filter-buttons button.active, .bucket-filter-buttons button:hover { background: #667eea; color: white; border-color: #667eea; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Glossary toggle
    function toggleGlossary() {
        const content = document.getElementById('glossary-content');
        const toggle = document.getElementById('glossary-toggle');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            if (toggle) toggle.textContent = 'â–²';
        } else {
            content.style.display = 'none';
            if (toggle) toggle.textContent = 'â–¼';
        }
    }

    // Filter vuln table by text search (combined with active severity button)
    function filterBucketVulns(input) {
        const td = input.closest('td');
        const text = input.value.toLowerCase();
        const activeBtn = td.querySelector('.bucket-filter-buttons button.active');
        const sev = activeBtn ? (activeBtn.dataset.sev || 'all') : 'all';
        td.querySelectorAll('.vuln-table tbody tr').forEach(row => {
            const matchText = !text || row.textContent.toLowerCase().includes(text);
            const matchSev = sev === 'all' || row.dataset.severity === sev;
            row.style.display = (matchText && matchSev) ? '' : 'none';
        });
    }

    // Filter vuln table by severity button (combined with active text search)
    function filterBucketSeverity(btn, sev) {
        const td = btn.closest('td');
        td.querySelectorAll('.bucket-filter-buttons button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        btn.dataset.sev = sev;
        const input = td.querySelector('.bucket-search-input');
        const text = input ? input.value.toLowerCase() : '';
        td.querySelectorAll('.vuln-table tbody tr').forEach(row => {
            const matchText = !text || row.textContent.toLowerCase().includes(text);
            const matchSev = sev === 'all' || row.dataset.severity === sev;
            row.style.display = (matchText && matchSev) ? '' : 'none';
        });
    }

    // Toggle expandable child-record row open/closed
    function toggleDetail(id, row) {
        const detail = document.getElementById(id);
        if (!detail) return;
        if (detail.style.display === 'none' || detail.style.display === '') {
            detail.style.display = 'table-row';
            row.classList.add('expanded');
        } else {
            detail.style.display = 'none';
            row.classList.remove('expanded');
        }
    }
</script>
{% endblock %}

{% block content %}

<!-- Summary cards -->
<div class="section">
    <h2>Overview</h2>
    <div class="summary-grid">
        {% for card in summary_cards %}
        {{ card|safe }}
        {% endfor %}
    </div>
</div>

<!-- Products table -->
<div class="section">
    <h2>Exploitable Findings by Product</h2>
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Total</th>
                    <th>Critical</th>
                    <th>High</th>
                    <th>Medium</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
            {% for p in products %}
                <tr{% if p.has_records %} class="data-row clickable" onclick="toggleDetail('detail-{{ loop.index }}', this)"{% endif %}>
                    <td>
                        <strong>{{ p.name }}</strong>
                    </td>
                    <td>{{ p.total }}</td>
                    <td class="{% if p.critical > 0 %}col-critical{% endif %}">{{ p.critical }}</td>
                    <td class="{% if p.high > 0 %}col-high{% endif %}">{{ p.high }}</td>
                    <td class="{% if p.medium > 0 %}col-medium{% endif %}">{{ p.medium }}</td>
                    <td>
                        <span class="status-badge status-{{ p.status_class }}">
                            {{ p.status }}
                        </span>
                    </td>
                </tr>
                {% if p.has_records %}
                <tr id="detail-{{ loop.index }}" class="detail-row">
                    <td colspan="6">
                        <div class="detail-content">{{ p.expanded_html|safe }}</div>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Glossary -->
<div class="glossary">
    <div class="glossary-header" onclick="toggleGlossary()">
        <h3>ðŸ“– What These Metrics Mean</h3>
        <span id="glossary-toggle" class="glossary-toggle">â–¼</span>
    </div>
    <div id="glossary-content" class="glossary-content" style="display:none">
        <div class="glossary-item">
            <div class="glossary-term">Exploitable</div>
            <div class="glossary-definition">
                A finding whose CVE appears in the
                <strong>CISA Known Exploited Vulnerabilities (KEV)</strong> catalogue,
                meaning there is confirmed evidence of active exploitation in the wild.
                This is the primary signal used to prioritise remediation.
            </div>
        </div>
        <div class="glossary-item">
            <div class="glossary-term">Critical / High / Medium</div>
            <div class="glossary-definition">
                Severity levels as assigned by ArmorCode. Only findings whose CVE is
                listed in the CISA KEV catalogue are counted here, regardless of
                severity. Counts are exact â€” no API result-limit truncation applies.
                Click any product row with findings to see up to 50 individual CISA KEV
                records for that product.
            </div>
        </div>
        <div class="glossary-item">
            <div class="glossary-term">Products Affected</div>
            <div class="glossary-definition">
                The number of distinct products that have at least one exploitable
                finding. All monitored products are shown in the table below,
                including those with zero CISA KEV findings (shown with a
                <strong>Good</strong> status).
            </div>
        </div>
        <div class="glossary-item">
            <div class="glossary-term">Status</div>
            <div class="glossary-definition">
                <strong>Action Needed</strong> â€” the product has one or more Critical or
                High CISA KEV findings requiring immediate attention.<br>
                <strong>Monitor</strong> â€” only Medium CISA KEV findings are present.<br>
                <strong>Good</strong> â€” no CISA KEV findings detected.
            </div>
        </div>
    </div>
</div>

{% endblock %}
