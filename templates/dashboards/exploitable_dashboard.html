{% extends "dashboards/base_dashboard.html" %}

{% block title %}Exploitable Vulnerabilities{% endblock %}
{% block meta_description %}Exploitable vulnerabilities with CISA KEV findings - Director Observatory{% endblock %}

{% block header_title %}Exploitable Vulnerabilities{% endblock %}
{% block header_subtitle %}Findings present in the CISA Known Exploited Vulnerabilities (KEV) catalogue{% endblock %}
{% block footer_context %}Exploitable Vulnerabilities Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* No-data state */
    .no-exploitable {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 0.9rem;
        padding: 4px 0;
    }

    /* Table column colours */
    td.col-critical { color: #dc2626; font-weight: 700; }
    td.col-high     { color: #ea580c; font-weight: 700; }
    td.col-medium   { color: #d97706; font-weight: 700; }

    /* Expandable rows â€” arrow handled by framework ::before on .data-row */
    tr.detail-row > td { padding: 0; border-top: none; }

    /* Vulnerability mini-table â€” theme-aware colours */
    .vuln-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .vuln-table th { background: var(--bg-secondary); color: var(--text-primary); padding: 6px 10px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border-color); }
    .vuln-table td { padding: 5px 10px; border-bottom: 1px solid var(--border-color); vertical-align: top; color: var(--text-primary); }
    .vuln-table tr:last-child td { border-bottom: none; }
    .sev-critical { color: #dc2626; font-weight: 700; }
    .sev-high     { color: #ea580c; font-weight: 700; }
    .sev-medium   { color: #d97706; font-weight: 600; }
    .truncation-note { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px; font-style: italic; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Glossary toggle
    function toggleGlossary() {
        const content = document.getElementById('glossary-content');
        const toggle = document.getElementById('glossary-toggle');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            if (toggle) toggle.textContent = 'â–²';
        } else {
            content.style.display = 'none';
            if (toggle) toggle.textContent = 'â–¼';
        }
    }

    // Toggle expandable child-record row open/closed
    function toggleDetail(id, row) {
        const detail = document.getElementById(id);
        if (!detail) return;
        if (detail.style.display === 'none' || detail.style.display === '') {
            detail.style.display = 'table-row';
            row.classList.add('expanded');
        } else {
            detail.style.display = 'none';
            row.classList.remove('expanded');
        }
    }
</script>
{% endblock %}

{% block content %}

<!-- Summary cards -->
<div class="section">
    <h2>Overview</h2>
    <div class="summary-grid">
        {% for card in summary_cards %}
        {{ card|safe }}
        {% endfor %}
    </div>
</div>

<!-- Products table -->
<div class="section">
    <h2>Exploitable Findings by Product</h2>
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Total</th>
                    <th>Critical</th>
                    <th>High</th>
                    <th>Medium</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
            {% for p in products %}
                <tr{% if p.has_records %} class="data-row clickable" onclick="toggleDetail('detail-{{ loop.index }}', this)"{% endif %}>
                    <td>
                        <strong>{{ p.name }}</strong>
                    </td>
                    <td>{{ p.total }}</td>
                    <td class="{% if p.critical > 0 %}col-critical{% endif %}">{{ p.critical }}</td>
                    <td class="{% if p.high > 0 %}col-high{% endif %}">{{ p.high }}</td>
                    <td class="{% if p.medium > 0 %}col-medium{% endif %}">{{ p.medium }}</td>
                    <td>
                        <span class="status-badge status-{{ p.status_class }}">
                            {{ p.status }}
                        </span>
                    </td>
                </tr>
                {% if p.has_records %}
                <tr id="detail-{{ loop.index }}" class="detail-row">
                    <td colspan="6">
                        <div class="detail-content">{{ p.expanded_html|safe }}</div>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Glossary -->
<div class="glossary">
    <div class="glossary-header" onclick="toggleGlossary()">
        <h3>ðŸ“– What These Metrics Mean</h3>
        <span id="glossary-toggle" class="glossary-toggle">â–¼</span>
    </div>
    <div id="glossary-content" class="glossary-content" style="display:none">
        <div class="glossary-item">
            <div class="glossary-term">Exploitable</div>
            <div class="glossary-definition">
                A finding whose CVE appears in the
                <strong>CISA Known Exploited Vulnerabilities (KEV)</strong> catalogue,
                meaning there is confirmed evidence of active exploitation in the wild.
                This is the primary signal used to prioritise remediation.
            </div>
        </div>
        <div class="glossary-item">
            <div class="glossary-term">Critical / High / Medium</div>
            <div class="glossary-definition">
                Severity levels as assigned by ArmorCode. Only findings whose CVE is
                listed in the CISA KEV catalogue are counted here, regardless of
                severity. Counts are exact â€” no API result-limit truncation applies.
                Click any product row with findings to see up to 50 individual CISA KEV
                records for that product.
            </div>
        </div>
        <div class="glossary-item">
            <div class="glossary-term">Products Affected</div>
            <div class="glossary-definition">
                The number of distinct products that have at least one exploitable
                finding. All monitored products are shown in the table below,
                including those with zero CISA KEV findings (shown with a
                <strong>Good</strong> status).
            </div>
        </div>
        <div class="glossary-item">
            <div class="glossary-term">Status</div>
            <div class="glossary-definition">
                <strong>Action Needed</strong> â€” the product has one or more Critical or
                High CISA KEV findings requiring immediate attention.<br>
                <strong>Monitor</strong> â€” only Medium CISA KEV findings are present.<br>
                <strong>Good</strong> â€” no CISA KEV findings detected.
            </div>
        </div>
    </div>
</div>

{% endblock %}
