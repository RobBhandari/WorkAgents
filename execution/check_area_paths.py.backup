#!/usr/bin/env python3
"""
Check area paths for ALCM bugs to find the missing 3 bugs
"""
import os
import sys
from pathlib import Path
from dotenv import load_dotenv
from azure.devops.connection import Connection
from msrest.authentication import BasicAuthentication
from azure.devops.v7_1.work_item_tracking import Wiql

# Load environment variables
load_dotenv()

org_url = os.getenv('ADO_ORGANIZATION_URL')
pat = os.getenv('ADO_PAT')

if not org_url or not pat:
    print("ERROR: Missing Azure DevOps credentials")
    sys.exit(1)

print("Connecting to Azure DevOps...")
creds = BasicAuthentication('', pat)
connection = Connection(base_url=org_url, creds=creds)
wit_client = connection.clients.get_work_item_tracking_client()
print("[SUCCESS] Connected\n")

# Query ALL open bugs from ALCM (no area path filter)
project_name = 'Access Legal Case Management'
print(f"Querying ALL open bugs from: {project_name}\n")

wiql_all = Wiql(
    query=f"""
    SELECT [System.Id], [System.Title], [System.AreaPath], [System.State]
    FROM WorkItems
    WHERE [System.TeamProject] = '{project_name}'
      AND [System.WorkItemType] = 'Bug'
      AND [System.State] <> 'Closed'
      AND [System.State] <> 'Removed'
    ORDER BY [System.AreaPath]
    """
)

# Query bugs EXCLUDING OneOffice
wiql_exclude = Wiql(
    query=f"""
    SELECT [System.Id]
    FROM WorkItems
    WHERE [System.TeamProject] = '{project_name}'
      AND [System.WorkItemType] = 'Bug'
      AND [System.State] <> 'Closed'
      AND [System.State] <> 'Removed'
      AND [System.AreaPath] NOT UNDER 'Access Legal Case Management\\OneOffice and Financial Director'
    """
)

# Query bugs INCLUDING ONLY OneOffice
wiql_include = Wiql(
    query=f"""
    SELECT [System.Id]
    FROM WorkItems
    WHERE [System.TeamProject] = '{project_name}'
      AND [System.WorkItemType] = 'Bug'
      AND [System.State] <> 'Closed'
      AND [System.State] <> 'Removed'
      AND [System.AreaPath] UNDER 'Access Legal Case Management\\OneOffice and Financial Director'
    """
)

# Execute queries
all_result = wit_client.query_by_wiql(wiql_all)
exclude_result = wit_client.query_by_wiql(wiql_exclude)
include_result = wit_client.query_by_wiql(wiql_include)

all_ids = set(item.id for item in all_result.work_items) if all_result.work_items else set()
exclude_ids = set(item.id for item in exclude_result.work_items) if exclude_result.work_items else set()
include_ids = set(item.id for item in include_result.work_items) if include_result.work_items else set()

print(f"Total open bugs: {len(all_ids)}")
print(f"Bugs EXCLUDING OneOffice: {len(exclude_ids)}")
print(f"Bugs ONLY in OneOffice: {len(include_ids)}")
print(f"Combined (exclude + include): {len(exclude_ids) + len(include_ids)}")
print(f"\nDifference: {len(all_ids)} - {len(exclude_ids) + len(include_ids)} = {len(all_ids) - (len(exclude_ids) + len(include_ids))}")

# Find bugs that are in neither set
missing_ids = all_ids - exclude_ids - include_ids

if missing_ids:
    print(f"\n{'='*80}")
    print(f"FOUND {len(missing_ids)} BUGS NOT CAPTURED BY EITHER FILTER:")
    print(f"{'='*80}")

    # Get full details of missing bugs
    bugs = wit_client.get_work_items(
        list(missing_ids),
        fields=['System.Id', 'System.Title', 'System.AreaPath', 'System.State', 'System.CreatedDate']
    )

    for bug in bugs:
        print(f"\nBug #{bug.id}")
        print(f"  Title: {bug.fields.get('System.Title', 'No title')}")
        print(f"  Area Path: {bug.fields.get('System.AreaPath', 'No area path')}")
        print(f"  State: {bug.fields.get('System.State', 'Unknown')}")
        print(f"  Created: {bug.fields.get('System.CreatedDate', 'Unknown')}")
else:
    print(f"\nâœ“ No bugs missing - filters are complete!")

# Check for any overlap (shouldn't be any)
overlap_ids = exclude_ids & include_ids
if overlap_ids:
    print(f"\n{'='*80}")
    print(f"WARNING: {len(overlap_ids)} bugs appear in BOTH filters (shouldn't happen):")
    print(f"{'='*80}")
    print(f"IDs: {overlap_ids}")

# Count bugs by area path
print(f"\n{'='*80}")
print("AREA PATH DISTRIBUTION:")
print(f"{'='*80}")

if all_result.work_items:
    all_bug_ids = [item.id for item in all_result.work_items]
    all_bugs = wit_client.get_work_items(
        all_bug_ids,
        fields=['System.Id', 'System.AreaPath']
    )

    area_counts = {}
    for bug in all_bugs:
        area = bug.fields.get('System.AreaPath', 'No Area Path')
        area_counts[area] = area_counts.get(area, 0) + 1

    for area, count in sorted(area_counts.items(), key=lambda x: x[1], reverse=True):
        is_oneoffice = "OneOffice" in area
        marker = " [OneOffice]" if is_oneoffice else " [Main ALCM]"
        print(f"  {count:3d} bugs - {area}{marker}")
