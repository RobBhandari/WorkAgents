name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'execution/domain/**'
      - 'execution/collectors/**'
      - 'execution/dashboards/**'
      - 'execution/secure_config.py'
      - 'execution/http_client.py'
      - '.github/workflows/docs.yml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read

# Only allow one deployment at a time
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    name: Build Sphinx Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip setuptools wheel
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints
          # Install only runtime dependencies needed for autodoc (not the package itself)
          pip install python-dotenv requests httpx jinja2 pandas beautifulsoup4 lxml azure-devops google-api-python-client

      - name: Build documentation
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}:${PYTHONPATH}"
          cd docs
          sphinx-build -b html . _build/html
          touch _build/html/.nojekyll  # Disable Jekyll processing

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/_build/html'

  deploy:
    name: Deploy to Azure Static Web Apps
    needs: build
    runs-on: ubuntu-latest
    # Only deploy on manual workflow_dispatch trigger
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built documentation
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: docs/_build/html

      - name: Extract documentation files
        run: |
          cd docs/_build/html
          tar -xvf artifact.tar
          rm artifact.tar

      - name: Deploy documentation to Azure
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "docs/_build/html"
          skip_app_build: true
          skip_api_build: true

      - name: Deployment Complete
        run: |
          echo "âœ… Documentation deployed successfully to Azure Static Web Apps!"
          echo "ðŸ“š Docs will be available at: https://<your-app-name>.azurestaticapps.net/docs"
