name: CI - Quality Gates

# Enforce architectural standards on all code changes
# Runs same checks as pre-commit hooks, ensuring standards are met even if hooks are bypassed

on:
  push:
    branches: [main, develop]
    paths:
      - 'execution/**/*.py'
      - 'tests/**/*.py'
      - '.github/workflows/ci-quality-gates.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'execution/**/*.py'
      - 'tests/**/*.py'

jobs:
  # Job 1: Code Quality & Formatting
  code-quality:
    name: Code Quality (Ruff + Black)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install ruff black

      - name: Run Ruff linter
        run: |
          ruff check execution/ --exit-non-zero-on-fix
          echo "‚úÖ Ruff linting passed"

      - name: Run Black formatter
        run: |
          black --check execution/ tests/
          echo "‚úÖ Black formatting check passed"

  # Job 2: Architecture Governance
  architecture-governance:
    name: Architecture Patterns
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check Security Wrappers
        run: |
          echo "Checking for direct os.getenv() and requests imports..."
          find execution -name "*.py" -not -path "*/archive/*" -not -path "*/experiments/*" | xargs python hooks/check-security-wrappers.py || {
            echo "‚ùå Security wrapper violations found"
            echo "Use: secure_config.get_config() and http_client.get/post"
            exit 1
          }
          echo "‚úÖ Security wrapper check passed"

      - name: Check Architecture Patterns
        run: |
          echo "Checking architectural standards..."
          find execution -name "*.py" -not -path "*/archive/*" -not -path "*/experiments/*" | xargs python hooks/check-architecture-patterns.py || {
            echo "‚ùå Architecture violations found"
            echo "See: execution/CONTRIBUTING.md for guidelines"
            exit 1
          }
          echo "‚úÖ Architecture pattern check passed"

  # Job 3: Type Checking
  type-checking:
    name: Type Hints (MyPy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install mypy types-requests

      - name: Run MyPy on modular code
        run: |
          echo "Type checking domain models..."
          mypy execution/domain --ignore-missing-imports --check-untyped-defs

          echo "Type checking dashboards..."
          mypy execution/dashboards --ignore-missing-imports --check-untyped-defs

          echo "Type checking collectors..."
          mypy execution/collectors --ignore-missing-imports --check-untyped-defs || true

          echo "‚úÖ Type checking completed"

  # Job 4: Unit Tests
  unit-tests:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=execution --cov-report=term --cov-report=xml

      - name: Coverage check
        run: |
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; print(float(ET.parse('coverage.xml').getroot().attrib['line-rate']) * 100)")
          echo "Current coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 40" | bc -l) )); then
            echo "‚ùå Coverage below 40% threshold"
            exit 1
          fi
          echo "‚úÖ Coverage check passed (${COVERAGE}%)"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # Job 5: Security Scan
  security-scan:
    name: Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit security scanner
        run: |
          bandit -r execution/ -ll -x execution/archive,execution/experiments
          echo "‚úÖ Security scan passed"

  # Summary Job
  quality-gates-summary:
    name: ‚úÖ All Quality Gates Passed
    runs-on: ubuntu-latest
    needs: [code-quality, architecture-governance, type-checking, unit-tests, security-scan]
    steps:
      - name: Summary
        run: |
          echo "=================================================="
          echo "‚úÖ ALL QUALITY GATES PASSED"
          echo "=================================================="
          echo "‚úì Code quality (Ruff + Black)"
          echo "‚úì Architecture patterns"
          echo "‚úì Security wrappers"
          echo "‚úì Type checking"
          echo "‚úì Unit tests (>40% coverage)"
          echo "‚úì Security scan (Bandit)"
          echo "=================================================="
          echo "Code meets architectural standards! üéâ"
