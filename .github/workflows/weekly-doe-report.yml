name: DOE Weekly Bug Report

# Run every Friday at 7:00 AM UTC (adjust timezone as needed)
on:
  schedule:
    - cron: '0 7 * * 5'  # 7 AM UTC every Friday
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  send-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .tmp directory
        run: mkdir -p .tmp

      - name: Copy data files to .tmp
        run: |
          cp data/baseline*.json .tmp/ 2>/dev/null || echo "No baseline files"
          cp data/weekly_tracking*.json .tmp/ 2>/dev/null || echo "No tracking files"

      - name: Create .env file from secrets
        run: |
          cat << EOF > .env
          ADO_ORGANIZATION_URL=${{ secrets.ADO_ORGANIZATION_URL }}
          ADO_PROJECT_NAME=${{ secrets.ADO_PROJECT_NAME }}
          ADO_PAT=${{ secrets.ADO_PAT }}
          EMAIL_ADDRESS=${{ secrets.EMAIL_ADDRESS }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          EOF

      - name: Create baselines for all projects (if not exist)
        run: |
          python execution/ado_baseline.py --project "Access Legal Case Management" --project-key Access_Legal_Case_Management --force || echo "Baseline exists or failed"
          python execution/ado_baseline.py --project "Access LawFusion" --project-key LawFusion --force || echo "Baseline exists or failed"
          python execution/ado_baseline.py --project "Learning Content Legal" --project-key Learning_Content_Legal --force || echo "Baseline exists or failed"
          python execution/ado_baseline.py --project "Access LegalBricks" --project-key LegalBricks --force || echo "Baseline exists or failed"
          python execution/ado_baseline.py --project "Access Legal Compliance" --project-key Legal_Compliance --force || echo "Baseline exists or failed"
          python execution/ado_baseline.py --project "Access Legal InCase" --project-key Legal_InCase --force || echo "Baseline exists or failed"
          python execution/ado_baseline.py --project "Access Legal Proclaim" --project-key Legal_Proclaim --force || echo "Baseline exists or failed"
        continue-on-error: true

      - name: Run DOE tracker for Access Legal Case Management
        run: python execution/ado_doe_tracker.py --project "Access Legal Case Management" --project-key Access_Legal_Case_Management
        continue-on-error: false

      - name: Run DOE tracker for LawFusion
        run: python execution/ado_doe_tracker.py --project "Access LawFusion" --project-key LawFusion
        continue-on-error: false

      - name: Run DOE tracker for Learning Content Legal
        run: python execution/ado_doe_tracker.py --project "Learning Content Legal" --project-key Learning_Content_Legal
        continue-on-error: false

      - name: Run DOE tracker for LegalBricks
        run: python execution/ado_doe_tracker.py --project "Access LegalBricks" --project-key LegalBricks
        continue-on-error: false

      - name: Run DOE tracker for Legal Compliance
        run: python execution/ado_doe_tracker.py --project "Access Legal Compliance" --project-key Legal_Compliance
        continue-on-error: false

      - name: Run DOE tracker for Legal InCase
        run: python execution/ado_doe_tracker.py --project "Access Legal InCase" --project-key Legal_InCase
        continue-on-error: false

      - name: Run DOE tracker for Legal Proclaim
        run: python execution/ado_doe_tracker.py --project "Access Legal Proclaim" --project-key Legal_Proclaim
        continue-on-error: false

      - name: Send multi-project DOE report
        run: python execution/send_multi_project_report.py
        continue-on-error: false

      - name: Save updated tracking data back to repo
        run: |
          cp .tmp/weekly_tracking*.json data/ 2>/dev/null || echo "No tracking files to save"

      - name: Commit and push updated tracking data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Update weekly tracking data - Week ${{ github.run_number }}'
          file_pattern: 'data/weekly_tracking*.json'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doe-report-logs-${{ github.run_number }}
          path: .tmp/*.log
          retention-days: 30
